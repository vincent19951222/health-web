<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>血糖记录 - 控糖助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 糖尿病控糖管理平台 - 统一样式文件 */

        /* 颜色定义 */
        .colors {
            /* 主色调 */
            color: #3b82f6; /* 原 --primary-color: #667eea 改为蓝色 */
            color: #2563eb; /* 原 --primary-dark: #5a67d8 改为深蓝色 */
            color: #8b5cf6; /* 原 --secondary-color: #764ba2 改为紫色 */
            
            /* 医疗主题色彩 */
            color: #3b82f6; /* --medical-blue */
            color: #10b981; /* --medical-green */
            color: #ef4444; /* --medical-red */
            color: #f59e0b; /* --medical-orange */
            color: #8b5cf6; /* --medical-purple */
            
            /* 中性色 */
            color: #f9fafb; /* --gray-50 */
            color: #f3f4f6; /* --gray-100 */
            color: #e5e7eb; /* --gray-200 */
            color: #d1d5db; /* --gray-300 */
            color: #9ca3af; /* --gray-400 */
            color: #6b7280; /* --gray-500 */
            color: #4b5563; /* --gray-600 */
            color: #374151; /* --gray-700 */
            color: #1f2937; /* --gray-800 */
            color: #111827; /* --gray-900 */
        }

        /* 隐藏所有滚动条 */
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        *::-webkit-scrollbar {
            display: none;
        }
        
        /* 血糖记录页面的圆形进度条样式 */
        .blood-sugar-circle-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }

        /* 背景圆圈 */
        .background-circle {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 25%, #2563eb 50%, #1d4ed8 75%, #1e40af 100%);
            top: 0;
            left: 0;
        }

        .blood-sugar-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .blood-sugar-circle::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            bottom: 15px;
            background: white;
            border-radius: 50%;
            z-index: 1;
        }

        /* 进度环 */
        .progress-ring {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #3b82f6 0deg, #e5e7eb 0deg);
            mask: radial-gradient(circle at center, transparent 85px, black 85px);
            -webkit-mask: radial-gradient(circle at center, transparent 85px, black 85px);
            z-index: 2;
        }

        /* 可拖动的圆点 */
        .drag-handle {
            position: absolute;
            width: 24px;
            height: 24px;
            top: 50%;
            left: 50%;
            transform-origin: center;
            cursor: grab;
            z-index: 20;
        }

        .drag-dot {
            width: 32px;
            height: 32px;
            background: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .drag-handle:hover .drag-dot {
            transform: translate(-50%, -50%) scale(1.2);
            background: #2563eb;
        }

        .drag-handle.dragging .drag-dot {
            transform: translate(-50%, -50%) scale(1.3);
            background: #1d4ed8;
            cursor: grabbing;
        }

        /* 数字键盘样式 */
        .number-key {
            padding: 16px 16px;
            background-color: #f3f4f6;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 600;
            color: #374151;
            transition: all 0.2s ease;
        }

        .number-key:hover {
            background-color: #e5e7eb;
        }

        .number-key:active {
            background-color: #d1d5db;
        }

        /* 时间段选择器样式 */
        .time-period-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }
        
        .time-period-slider {
            display: flex;
            align-items: center;
            background: #ffffff;
            border-radius: 12px;
            padding: 0px;
            position: relative;
            min-width: 400px;
            justify-content: space-between;
        }
        
        .time-period-arrow {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            min-width: 32px;
            min-height: 32px;
        }
        
        .time-period-arrow:hover {
            background: #e5e7eb;
            color: #6b7280;
        }
        
        .time-period-arrow:active {
            transform: scale(0.95);
        }
        
        .time-period-arrow.disabled {
            color: #d1d5db;
            cursor: not-allowed;
        }
        
        .time-period-arrow.disabled:hover {
            background: transparent;
            color: #d1d5db;
        }
        
        .time-period-list {
            display: flex;
            gap: 4px;
            overflow: hidden;
            width: 280px;
            justify-content: center;
            flex-shrink: 1;
        }

        .time-period-list-full {
            display: flex;
            gap: 8px;
            justify-content: space-between;
            width: 100%;
            padding: 0 8px;
        }

        .time-period-list-scrollable {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            padding: 8px 4px;
            width: 100%;
        }

        .time-period-list-scrollable::-webkit-scrollbar {
            display: none;
        }
        
        .time-period-item {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12.8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            color: #6b7280;
            border: 2px solid transparent;
            flex: 0 0 auto;
        }
        
        .time-period-item.active {
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
            background: white;
        }
        
        .time-period-item:hover:not(.active) {
            color: #374151;
            background: #e5e7eb;
        }


        /* 圆环交互样式 */
        .blood-sugar-circle {
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .blood-sugar-circle:hover {
            filter: brightness(1.05);
        }
        
        /* 状态选项样式 */
        .status-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #ffffff;
            font-size: 14px;
        }
        
        .status-option:hover {
            background-color: #f9fafb;
            border-color: #d1d5db;
        }
        
        .status-option.selected {
            background-color: #eff6ff;
            border-color: #3b82f6;
            color: #1d4ed8;
        }
        
        .status-option.selected i {
            color: #3b82f6 !important;
        }

        /* 导航栏样式 */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 83px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding-bottom: 20px;
            z-index: 1000;
        }
        
        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 12px;
            position: relative;
        }
        
        .tab-item.active {
            color: #3b82f6;
        }
        
        .tab-item:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .tab-item.add-btn {
            background: #3b82f6;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .tab-item.add-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }
        
        .tab-item i {
            font-size: 20px;
            margin-bottom: 2px;
            transition: all 0.3s ease;
        }
        
        .tab-item span {
            font-size: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .tab-item.active i,
        .tab-item.active span {
            color: #3b82f6;
        }
        
        .tab-item:not(.active) i,
        .tab-item:not(.active) span {
            color: #9ca3af;
        }
        
        .tab-item.add-btn i {
            color: white;
            font-size: 24px;
            margin: 0;
        }
        
        .main-content {
            padding-bottom: 120px;
        }

        /* 底部悬浮按钮样式 */
        .manual-record-btn-container {
            background: #ffffff;
            border-radius: 0 0 30px 30px;
            padding: 10px;
            position: fixed;
            bottom: 0px;
            left: 0px;
            right: 0px;
            z-index: 999;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .manual-record-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
        }

        .manual-record-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }

        .manual-record-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
        }

        /* 智能测量设备列表样式 - 参考血压页面 */
        .device-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .device-card.connected {
            border-left: 4px solid #3b82f6;
        }

        .device-card.unconnected {
            border-left: 4px solid #d1d5db;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-connected {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .status-unconnected {
            background: rgba(156, 163, 175, 0.1);
            color: #6b7280;
        }

        .connect-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .connect-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .connect-btn:active {
            transform: translateY(0);
        }

        .connect-btn.disconnect {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .connect-btn.disconnect:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.2);
        }

        .connect-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 设备图片样式 */
        .device-image {
            width: 64px;
            height: 64px;
            object-fit: cover;
            border-radius: 12px;
        }

        /* 设备类型选择器样式 - 参考时间段选择器 */
        .device-type-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            margin-left: -16px;
            margin-right: -16px;
        }

        .device-type-slider {
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 25%, #2563eb 50%, #1d4ed8 75%, #1e40af 100%);
            border-radius: 0px;
            padding: 0px;
            position: relative;
            min-width: 400px;
            justify-content: space-between;
            width: 100%;
        }

        .device-type-list {
            display: flex;
            gap: 8px;
            overflow: hidden;
            width: 100%;
            justify-content: center;
            padding: 8px 16px;
        }

        .device-type-item {
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            color: #6b7280;
            border: 2px solid transparent;
            flex: 0 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .device-type-item.active {
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
            background: white;
        }

        .device-type-item:hover:not(.active) {
            color: #374151;
            background: #e5e7eb;
        }

        /* 蓝牙设备连接流程样式 */
        .bluetooth-flow-container {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .bluetooth-flow-container:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .status-indicator {
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .status-connecting {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .status-measuring {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .device-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
            margin: 0 auto;
        }

        .device-icon i {
            font-size: 48px;
            color: white;
        }

        .connecting-dots {
            display: inline-flex;
            gap: 4px;
        }

        .connecting-dots span {
            width: 8px;
            height: 8px;
            background: #3b82f6;
            border-radius: 50%;
            animation: connectingDots 1.4s ease-in-out infinite;
        }

        .connecting-dots span:nth-child(1) { animation-delay: 0s; }
        .connecting-dots span:nth-child(2) { animation-delay: 0.2s; }
        .connecting-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes connectingDots {
            0%, 60%, 100% { transform: scale(0.8); opacity: 0.5; }
            30% { transform: scale(1.2); opacity: 1; }
        }

        .info-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .info-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .flow-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .flow-btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .flow-btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
            transform: translateY(-1px);
        }

        .heartbeat-animation {
            animation: heartbeat 1.2s ease-in-out infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.1); }
            45% { transform: scale(0.9); }
            65% { transform: scale(1.05); }
        }
    </style>
</head>
<body>
    <div class="">
        <!-- 顶部Tab栏 -->
        <div class="">
            <div class="flex justify-between items-center px-4 py-2">
                <!-- 返回按钮 -->
                <button onclick="goBack()" class="text-gray-600">
                    <i class="fas fa-chevron-left text-xl"></i>
                </button>

                <!-- 中间Tab栏 -->
                <div class="flex flex-1 justify-center">
                    <div class="flex">
                        <div class="px-4 py-2 cursor-pointer" onclick="switchToManual()">
                            <span id="manualTab" class="text-blue-500 text-lg font-bold">手动输入</span>
                        </div>
                        <div class="px-4 py-2 cursor-pointer" onclick="switchToSmart()">
                            <span id="smartTab" class="text-gray-900 text-lg font-medium">智能测量</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 蓝色渐变背景区域（从标题栏下方开始） -->
        <div class="bg-gradient-to-b from-blue-500 to-blue-600">
            <div class="px-2 py-2">
                
                <!-- 时间段选择 -->
                <div class="time-period-container">
                    <div class="time-period-slider">
                        <!-- 时间段列表 -->
                        <div class="time-period-list-scrollable" id="timePeriodList">
                            <!-- 时间段项目将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>

                <!-- 血糖值显示圆圈 -->
                <div class="pb-4">
                        <div class="blood-sugar-circle-container">
                            <!-- 背景圆圈 -->
                            <div class="background-circle"></div>
                            <div class="blood-sugar-circle" id="bloodSugarCircle">
                                <!-- 进度环 -->
                                <div class="progress-ring" id="progressRing"></div>
                                <!-- 中心数值 -->
                                <div class="absolute inset-0 flex flex-col items-center justify-center z-10">
                                    <i id="bloodSugarDisplay" class="fas fa-pen text-2xl text-black cursor-pointer mb-1" onclick="showNumberInput()" title="点击输入血糖值"></i>
                                    <span class="text-xs text-black mb-1">请输入</span>
                                    <span class="text-sm text-black">mmol/L</span>
                                </div>
                                <!-- 可拖动的圆点 -->
                                <div class="drag-handle" id="dragHandle">
                                    <div class="drag-dot"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 操作提示 -->
                <div class="text-center mb-2">
                    <p class="text-sm text-white">拖动圆点或点击数值输入血糖值</p>
                    <p class="text-xs text-blue-100 mt-1">数值范围 0.1-30.0 mmol/L</p>
                </div>
            </div>
              </div>
        </div> <!-- 蓝色渐变背景区域结束 -->

        <!-- 手动输入内容区域 -->
        <div id="manualContent" class="bg-gray-50 px-4 pt-3" style="padding-bottom: 120px;">

        <!-- 记录时间和个体状态卡片 -->
        <div class="bg-white rounded-2xl p-4 mb-3 shadow-sm">
            <!-- 记录时间 -->
            <div class="flex justify-between items-center mb-4">
                <span class="text-sm text-gray-600">记录时间</span>
                <div class="flex items-center cursor-pointer" onclick="showTimePicker()">
                    <span id="recordDateTime" class="text-sm text-gray-800">2025.09.09 15:17</span>
                    <i class="fas fa-chevron-down ml-2 text-gray-400"></i>
                </div>
            </div>

            <!-- 个体状态 -->
            <div class="border-t pt-4">
                <span class="text-sm text-gray-600 mb-4 block">个体状态（可选）</span>
                <div class="grid grid-cols-3 gap-2" id="statusOptions">
                    <div class="status-option" data-status="无不适">
                        <i class="fas fa-smile text-green-500 mr-2"></i>
                        <span>无不适</span>
                    </div>
                    <div class="status-option" data-status="尿多">
                        <i class="fas fa-tint text-blue-500 mr-2"></i>
                        <span>尿多</span>
                    </div>
                    <div class="status-option" data-status="口渴">
                        <i class="fas fa-tint text-cyan-500 mr-2"></i>
                        <span>口渴</span>
                    </div>
                    <div class="status-option" data-status="饥饿">
                        <i class="fas fa-utensils text-yellow-500 mr-2"></i>
                        <span>饥饿</span>
                    </div>
                    <div class="status-option" data-status="乏力">
                        <i class="fas fa-battery-quarter text-orange-500 mr-2"></i>
                        <span>乏力</span>
                    </div>
                    <div class="status-option" data-status="头痛">
                        <i class="fas fa-head-side-cough text-red-500 mr-2"></i>
                        <span>头痛</span>
                    </div>
                    <div class="status-option" data-status="出汗">
                        <i class="fas fa-tint text-indigo-500 mr-2"></i>
                        <span>出汗</span>
                    </div>
                    <div class="status-option" data-status="心悸">
                        <i class="fas fa-heartbeat text-red-500 mr-2"></i>
                        <span>心悸</span>
                    </div>
                    <div class="status-option" data-status="其他">
                        <i class="fas fa-ellipsis-h text-gray-500 mr-2"></i>
                        <span>其他</span>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- 智能测量设备列表区域 -->
        <div id="smartContent" class="px-0 py-0" style="display: none;">
            <!-- 设备类型切换标签 -->
            <div class="device-type-container">
                <div class="device-type-slider">
                    <!-- 设备类型列表 -->
                    <div class="device-type-list">
                        <div id="bluetoothTab" onclick="switchDeviceType('bluetooth')" class="device-type-item active">
                            <i class="fas fa-vial mr-2"></i>
                            蓝牙血糖仪
                        </div>
                        <div id="gprsTab" onclick="switchDeviceType('gprs')" class="device-type-item">
                            <i class="fas fa-signal mr-2"></i>
                            4G血糖仪
                        </div>
                    </div>
                </div>
            </div>

            <!-- 蓝牙血糖仪设备连接流程 - 全屏嵌入 -->
            <div id="bluetoothDeviceList" class="min-h-screen bg-gray-50">
                <div class="min-h-screen">
                    <!-- 主要内容区域 -->
                    <div class="flex-1 flex items-center justify-center px-4 py-4">
                        <div class="text-center max-w-md w-full fade-in">
                            <!-- 状态指示器 -->
                            <div id="statusContainer" class="mb-4">
                                <div id="statusIndicator" class="status-indicator status-connecting">
                                    <div class="connecting-dots">
                                        <span></span>
                                        <span></span>
                                        <span></span>
                                    </div>
                                    <span>连接中</span>
                                </div>
                            </div>

                            <!-- Toast消息内容 -->
                            <div class="toast-message mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="flex items-center text-blue-800">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    <span id="flowMessage">正在搜索设备，请稍候…</span>
                                </div>
                            </div>
 
                           <!-- 设备图片 -->
                            <div class="flex items-center justify-center mb-4" style="min-height: 200px;">
                                <img src="../imgs/蓝牙-血糖仪.png" alt="血糖仪" class="w-[28rem] h-[28rem] object-contain" style="max-width: 100%; max-height: 200px;">
                            </div>

                            <!-- 操作说明 -->
                            <div class="info-card mb-6">
                                <h3 class="font-semibold text-gray-800 mb-3">操作说明</h3>
                                <div class="text-sm text-gray-600 space-y-2">
                                    <div class="flex items-start">
                                        <i class="fas fa-power-off text-blue-500 mt-1 mr-2 flex-shrink-0"></i>
                                        <span>请确保设备已开机，手机蓝牙功能已开启</span>
                                    </div>
                                    <div class="flex items-start">
                                        <i class="fas fa-mobile-alt text-blue-500 mt-1 mr-2 flex-shrink-0"></i>
                                        <span>将设备靠近手机（距离小于1米）以便更好连接</span>
                                    </div>
                                    <div class="flex items-start">
                                        <i class="fas fa-tint text-blue-500 mt-1 mr-2 flex-shrink-0"></i>
                                        <span>请按照设备说明进行血糖测量</span>
                                    </div>
                                    <div class="flex items-start">
                                        <i class="fas fa-chart-line text-blue-500 mt-1 mr-2 flex-shrink-0"></i>
                                        <span>测量数据将自动同步到云端</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 操作按钮 -->
                            <div id="actionButtonContainer">
                                <button id="actionButton" onclick="handleAction()" class="flow-btn flow-btn-primary">
                                    <i class="fas fa-times mr-2"></i>
                                    取消连接
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4G血糖仪设备列表 -->
            <div id="gprsDeviceList" class="px-4 pt-4 pb-6" style="display: none;">
                <!-- 设备列表标题 -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 text-center">请选择4G血糖测量设备</h3>
                    <p class="text-sm text-gray-600 text-center px-2">首次使用需扫码绑定，绑定后每次测量，数据自动上传</p>
                </div>

                <div class="space-y-4">
                    <!-- 优唐医生血压/血糖/尿酸/血酮测试仪(Y916D-4G版) -->
                    <div class="device-card unconnected" onclick="navigateToDeviceDetail(event, 'yasu-76l')" style="cursor: pointer;">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <div class="mr-4">
                                    <img src="./../imgs/四合一血糖.png" alt="四合一血糖仪" class="device-image" onerror="this.src='./../imgs/device-placeholder.png';">
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800">优唐医生血压/血糖/尿酸/血酮测试仪(Y916D-4G版)</h4>
                                    <p class="text-xs text-gray-500 mt-1">语音播报，5秒出值，一机测四项，新时代智能黑科技</p>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>

                        <!-- 底部操作区域 -->
                        <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                            <button onclick="event.stopPropagation(); connectDevice('gprs-1')" class="connect-btn px-2 py-2 rounded-lg text-sm font-medium transition-all duration-200 w-28">
                                <i class="fas fa-link mr-1"></i>
                                绑定设备
                            </button>
                            <button onclick="event.stopPropagation(); window.location.href='help.html?from=blood-sugar'" class="text-gray-500 text-sm hover:text-gray-700 flex items-center">
                                <i class="fas fa-question-circle mr-1"></i>
                                使用帮助
                            </button>
                        </div>
                    </div>

                    <!-- 爱奥乐4G血糖仪 -->
                    <div class="device-card connected" onclick="navigateToDeviceDetail(event, 'aole-gprs')" style="cursor: pointer;">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <div class="mr-4">
                                    <img src="./../imgs/雅思.jpg" alt="爱奥乐4G血糖仪" class="device-image" onerror="this.src='./../imgs/device-placeholder.png';">
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800">爱奥乐血糖仪（4G版</h4>
                                    <p class="text-xs text-gray-500 mt-1">微量采血、8秒检测、高低警示、分类记忆</p>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>

                        <!-- 底部操作区域 -->
                        <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                            <button onclick="event.stopPropagation(); connectDevice('gprs-2')" class="connect-btn disconnect px-2 py-2 rounded-lg text-sm font-medium transition-all duration-200 w-28">
                                <i class="fas fa-unlink mr-1"></i>
                                解除绑定
                            </button>
                            <button onclick="event.stopPropagation(); window.location.href='help.html?from=blood-sugar'" class="text-gray-500 text-sm hover:text-gray-700 flex items-center">
                                <i class="fas fa-question-circle mr-1"></i>
                                使用帮助
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 咨询购买提示 -->
                <div class="px-4 pb-6">
                    <div class="text-center">
                        <p class="text-gray-600 mb-4 mt-8">还没有血糖仪设备？请咨询门店健康管理师购买。</p>
                        <button onclick="contactCustomerService()" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-3 rounded-full font-medium shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                            <i class="fas fa-comments mr-2"></i>
                            联系客服
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部悬浮保存按钮 -->
    <div class="manual-record-btn-container">
        <button onclick="saveRecord()" class="manual-record-btn">
            保存
        </button>
    </div>

    <!-- 底部导航栏已隐藏 -->

    <!-- 数字输入弹窗 -->
    <div id="numberInputModal" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden">
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl max-h-[85vh]">
            <!-- 标题栏 -->
            <div class="text-center px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-800" id="numberInputTitle">输入血糖值</h3>
            </div>

            <!-- 输入显示区域 -->
            <div class="px-6 py-4">
                <div class="bg-gray-50 rounded-2xl p-4">
                    <div class="text-center">
                        <div id="numberDisplay" class="text-5xl font-bold text-gray-800">0</div>
                        <span class="text-sm text-gray-500 block mt-2">mmol/L</span>
                    </div>
                </div>

                <!-- 数字键盘 -->
                <div class="grid grid-cols-3 gap-3 mt-4">
                    <button onclick="inputNumber(1)" class="number-key">1</button>
                    <button onclick="inputNumber(2)" class="number-key">2</button>
                    <button onclick="inputNumber(3)" class="number-key">3</button>
                    <button onclick="inputNumber(4)" class="number-key">4</button>
                    <button onclick="inputNumber(5)" class="number-key">5</button>
                    <button onclick="inputNumber(6)" class="number-key">6</button>
                    <button onclick="inputNumber(7)" class="number-key">7</button>
                    <button onclick="inputNumber(8)" class="number-key">8</button>
                    <button onclick="inputNumber(9)" class="number-key">9</button>
                    <button onclick="inputNumber('.')" class="number-key">.</button>
                    <button onclick="inputNumber(0)" class="number-key">0</button>
                    <button onclick="deleteNumber()" class="number-key delete">
                        <i class="fas fa-backspace"></i>
                    </button>
                </div>
            </div>

            <!-- 底部按钮 -->
            <div class="flex px-6 py-4 border-t border-gray-100">
                <button onclick="hideNumberInput()" class="flex-1 py-3 text-gray-600 border border-gray-300 rounded-xl mr-3">
                    取消
                </button>
                <button onclick="confirmNumberInput()" class="flex-1 py-3 bg-blue-500 text-white rounded-xl">
                    确定
                </button>
            </div>
        </div>
    </div>

    <!-- 时间选择器弹窗 -->
    <div id="timePickerModal" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden">
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl">
            <!-- 标题栏 -->
            <div class="text-center px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-800">选择血糖记录时间</h3>
            </div>

            <!-- 选择器区域 -->
            <div class="px-6 py-4">
                <div class="flex justify-center items-center h-64">
                    <!-- 日期选择器 -->
                    <div class="flex-1 h-full overflow-hidden">
                        <div class="text-center text-sm text-gray-500 mb-2">日期</div>
                        <div class="h-48 overflow-y-auto" id="datePicker">
                            <!-- 日期选项将通过JavaScript生成 -->
                        </div>
                    </div>

                    <!-- 小时选择器 -->
                    <div class="flex-1 h-full overflow-hidden">
                        <div class="text-center text-sm text-gray-500 mb-2">时</div>
                        <div class="h-48 overflow-y-auto" id="hourPicker">
                            <!-- 小时选项将通过JavaScript生成 -->
                        </div>
                    </div>

                    <!-- 分钟选择器 -->
                    <div class="flex-1 h-full overflow-hidden">
                        <div class="text-center text-sm text-gray-500 mb-2">分</div>
                        <div class="h-48 overflow-y-auto" id="minutePicker">
                            <!-- 分钟选项将通过JavaScript生成 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 按钮区域 -->
            <div class="px-6 py-4 border-t border-gray-100">
                <div class="flex gap-3">
                    <button onclick="hideTimePicker()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-full font-semibold hover:bg-gray-300 transition-colors">
                        取消
                    </button>
                    <button onclick="confirmTimeSelection()" class="flex-1 bg-blue-500 text-white py-3 rounded-full font-semibold hover:bg-blue-600 transition-colors">
                        确定
                    </button>
                </div>
            </div>
        </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        let currentValue = '0.1';
        let selectedPeriod = '午餐后';

        // 圆环拖动相关变量
        let isDragging = false;
        let dragStartAngle = 0;
        let currentAngle = 0; // 起始角度（12点钟方向，对应CSS的0deg）
        
        // 时间段数据
        const timePeriods = ['凌晨', '空腹', '早餐后', '午餐前', '午餐后', '晚餐前', '晚餐后', '睡前', '随机'];
        let currentStartIndex = 0; // 当前显示的起始索引
        const visibleCount = 5; // 可见的时间段数量

        // 导航函数
        function navigateToPage(page) {
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'navigate',
                    page: page
                }, '*');
            } else {
                window.location.href = page + '.html';
            }
        }

        // 显示记录弹窗
        function showRecordModal() {
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'showRecordModal'
                }, '*');
            } else {
                // 在独立页面中，直接跳转到记录页面
                window.location.href = 'record.html';
            }
        }

        // 监听来自父窗口的消息
        window.addEventListener('message', function(event) {
            if (event.data.type === 'updateActiveTab') {
                // 更新活动标签状态
                const tabItems = document.querySelectorAll('.tab-item');
                tabItems.forEach(item => item.classList.remove('active'));
                
                const activeTab = document.querySelector(`.tab-item[onclick="navigateToPage('${event.data.page}')"]`);
                if (activeTab) {
                    activeTab.classList.add('active');
                }
            }
        });

        // 初始化页面
        function initializePage() {
            updateDateTime();
            updateDisplay();

            // 初始化时间段选择器
            initializeTimePeriods();

            // 初始化拖动控制
            initializeDragControls();

            // 初始化状态选项
            initializeStatusOptions();

            // 设置当前页面的导航栏active状态
            setInitialActiveTab();

            // 初始化圆点和进度环位置
            updateDragHandlePosition();

            // 每分钟更新时间
            setInterval(updateDateTime, 60000);
        }
        
        // 设置初始的active标签状态
        function setInitialActiveTab() {
            // 移除所有标签的active状态
            const tabItems = document.querySelectorAll('.tab-item');
            tabItems.forEach(item => item.classList.remove('active'));
            
            // 设置profile页面为active状态（当前页面）
            const profileTab = document.querySelector('.tab-item[onclick="navigateToPage(\'profile\')"]');
            if (profileTab) {
                profileTab.classList.add('active');
            }
        }
        
        // 初始化时间段选择器
        function initializeTimePeriods() {
            // 设置默认时间段为当前时间对应的时间段
            selectedPeriod = getDefaultTimePeriod();
            renderTimePeriods();
        }
        
        // 根据当前时间获取默认时间段
        function getDefaultTimePeriod() {
            const hour = new Date().getHours();

            if (hour >= 0 && hour < 5) return '凌晨';
            if (hour >= 5 && hour < 7) return '空腹';
            if (hour >= 7 && hour < 10) return '早餐后';
            if (hour >= 10 && hour < 12) return '午餐前';
            if (hour >= 12 && hour < 14) return '午餐后';
            if (hour >= 14 && hour < 17) return '晚餐前';
            if (hour >= 17 && hour < 20) return '晚餐后';
            if (hour >= 20 && hour < 23) return '睡前';
            return '随机';
        }

        // 渲染时间段列表
        function renderTimePeriods() {
            const container = document.getElementById('timePeriodList');
            container.innerHTML = '';

            // 渲染所有时间段
            timePeriods.forEach(period => {
                const item = document.createElement('div');
                item.className = 'time-period-item flex-shrink-0';
                item.textContent = period;
                item.dataset.period = period;

                if (period === selectedPeriod) {
                    item.classList.add('active');
                }

                item.addEventListener('click', function() {
                    selectTimePeriod(period);
                    // 滚动到选中项
                    item.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                });

                container.appendChild(item);
            });

            // 滚动到当前选中项
            const activeItem = container.querySelector('.time-period-item.active');
            if (activeItem) {
                setTimeout(() => {
                    activeItem.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }, 100);
            }
        }
        
                
        // 选择时间段
        function selectTimePeriod(period) {
            selectedPeriod = period;
            renderTimePeriods();
        }

        // 更新日期时间显示
        function updateDateTime() {
            selectedDateTime = new Date();
            updateDateTimeDisplay();
        }

  
                
  
        // 更新显示
        function updateDisplay() {
const displayElement = document.getElementById('bloodSugarDisplay');            if (currentValue === '0.1' || currentValue === 0 || currentValue === '0.0') {                displayElement.className = 'fas fa-pen text-3xl text-white cursor-pointer';                displayElement.textContent = '';                displayElement.setAttribute('title', '点击输入血糖值');            } else {                displayElement.className = 'text-4xl font-bold text-white cursor-pointer';                displayElement.textContent = currentValue;                displayElement.removeAttribute('title');            }
            updateProgressRing();
        }

        // 保存记录
        function saveRecord() {
            const value = parseFloat(currentValue);

            if (isNaN(value) || value <= 0) {
                alert('请输入有效的血糖值');
                return;
            }

            if (value > 30) {
                alert('血糖值过高，请检查输入');
                return;
            }

            // 创建记录对象 - 个体状态为可选，如果没有选择则为空数组
            const record = {
                value: value,
                period: selectedPeriod,
                timestamp: selectedDateTime.toISOString(),
                date: selectedDateTime.toLocaleDateString('zh-CN'),
                time: selectedDateTime.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }),
                statuses: selectedStatuses || [] // 个体状态为可选
            };

            // 保存到本地存储
            let records = JSON.parse(localStorage.getItem('bloodSugarRecords') || '[]');
            records.push(record);
            localStorage.setItem('bloodSugarRecords', JSON.stringify(records));

            // 跳转到结果页面，传递记录数据
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) + ' ' + now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const params = new URLSearchParams({
                value: value.toFixed(1),
                period: selectedPeriod,
                dateTime: dateStr
            });
            
            // 跳转到结果页面
            window.location.href = `blood_sugar_record_result.html?${params.toString()}`;
        }

        // 返回首页
        function goBack() {
            window.location.href = 'home.html';
        }

        // 状态选项管理
        let selectedStatuses = [];

        // 时间选择器相关
        let selectedDateTime = new Date();
        let pickerSelectedDate = new Date();
        let pickerSelectedHour = 0;
        let pickerSelectedMinute = 0;
        
        function initializeStatusOptions() {
            const statusOptions = document.querySelectorAll('.status-option');
            statusOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const status = this.getAttribute('data-status');
                    toggleStatus(status, this);
                });
            });
        }
        
        function toggleStatus(status, element) {
            const index = selectedStatuses.indexOf(status);
            if (index > -1) {
                // 取消选择
                selectedStatuses.splice(index, 1);
                element.classList.remove('selected');
            } else {
                // 添加选择
                selectedStatuses.push(status);
                element.classList.add('selected');
            }
        }

        // 时间选择器函数
        function showTimePicker() {
            const modal = document.getElementById('timePickerModal');

            // 初始化选择器值
            pickerSelectedDate = new Date(selectedDateTime);
            pickerSelectedHour = selectedDateTime.getHours();
            pickerSelectedMinute = selectedDateTime.getMinutes();

            // 生成选择器选项
            generateDatePickerOptions();
            generateHourPickerOptions();
            generateMinutePickerOptions();

            modal.classList.remove('hidden');
        }

        function hideTimePicker() {
            const modal = document.getElementById('timePickerModal');
            modal.classList.add('hidden');
        }

        function generateDatePickerOptions() {
            const container = document.getElementById('datePicker');
            container.innerHTML = '';

            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 30); // 显示过去30天

            const endDate = new Date(today);
            endDate.setDate(today.getDate() + 7); // 显示未来7天

            const currentDate = new Date(startDate);

            while (currentDate <= endDate) {
                const option = document.createElement('div');
                option.className = 'py-3 px-4 text-center cursor-pointer hover:bg-gray-50';
                option.textContent = currentDate.toLocaleDateString('zh-CN', {
                    month: '2-digit',
                    day: '2-digit'
                });

                if (currentDate.toDateString() === pickerSelectedDate.toDateString()) {
                    option.className += ' text-blue-600 font-semibold bg-blue-50';
                }

                option.addEventListener('click', function() {
                    pickerSelectedDate = new Date(currentDate);
                    generateDatePickerOptions();
                });

                container.appendChild(option);
                currentDate.setDate(currentDate.getDate() + 1);
            }
        }

        function generateHourPickerOptions() {
            const container = document.getElementById('hourPicker');
            container.innerHTML = '';

            for (let i = 0; i < 24; i++) {
                const option = document.createElement('div');
                option.className = 'py-3 px-4 text-center cursor-pointer hover:bg-gray-50';
                option.textContent = i.toString().padStart(2, '0');

                if (i === pickerSelectedHour) {
                    option.className += ' text-blue-600 font-semibold bg-blue-50';
                }

                option.addEventListener('click', function() {
                    pickerSelectedHour = i;
                    generateHourPickerOptions();
                });

                container.appendChild(option);
            }
        }

        function generateMinutePickerOptions() {
            const container = document.getElementById('minutePicker');
            container.innerHTML = '';

            for (let i = 0; i < 60; i += 1) {
                const option = document.createElement('div');
                option.className = 'py-3 px-4 text-center cursor-pointer hover:bg-gray-50';
                option.textContent = i.toString().padStart(2, '0');

                if (i === pickerSelectedMinute) {
                    option.className += ' text-blue-600 font-semibold bg-blue-50';
                }

                option.addEventListener('click', function() {
                    pickerSelectedMinute = i;
                    generateMinutePickerOptions();
                });

                container.appendChild(option);
            }
        }

        function confirmTimeSelection() {
            selectedDateTime = new Date(pickerSelectedDate);
            selectedDateTime.setHours(pickerSelectedHour);
            selectedDateTime.setMinutes(pickerSelectedMinute);

            updateDateTimeDisplay();
            hideTimePicker();
        }

        function updateDateTimeDisplay() {
            const dateStr = selectedDateTime.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).replace(/\//g, '.');
            const timeStr = selectedDateTime.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });

            document.getElementById('recordDateTime').textContent = `${dateStr} ${timeStr}`;
        }
        
        // 数字输入弹窗函数
        // 数字输入相关变量
        let currentNumberInput = '0';

        // 数字输入功能
        function showNumberInput() {
            currentNumberInput = '0';

            const modal = document.getElementById('numberInputModal');
            const title = document.getElementById('numberInputTitle');
            const display = document.getElementById('numberDisplay');

            title.textContent = '输入血糖值';
            currentNumberInput = currentValue;

            display.textContent = currentNumberInput;
            modal.classList.remove('hidden');
        }

        function hideNumberInput() {
            const modal = document.getElementById('numberInputModal');
            modal.classList.add('hidden');
        }

        function inputNumber(num) {
            if (currentNumberInput === '0' && num !== '.') {
                currentNumberInput = num.toString();
            } else {
                currentNumberInput += num.toString();
            }

            // 限制长度
            if (currentNumberInput.length > 5) {
                currentNumberInput = currentNumberInput.substring(0, 5);
            }

            document.getElementById('numberDisplay').textContent = currentNumberInput;
        }

        function deleteNumber() {
            if (currentNumberInput.length > 1) {
                currentNumberInput = currentNumberInput.substring(0, currentNumberInput.length - 1);
            } else {
                currentNumberInput = '0';
            }
            document.getElementById('numberDisplay').textContent = currentNumberInput;
        }

        function confirmNumberInput() {
            const value = parseFloat(currentNumberInput);
            if (value >= 1.0 && value <= 30.0) {
                // 更新血糖值
                currentValue = value.toFixed(1);
                updateDisplay();

                // 更新圆环进度
                updateCircleProgress();

                hideNumberInput();
            } else {
                alert('血糖值应在 1.0-30.0 mmol/L 范围内');
            }
        }

        // 圆环拖动功能
        function initializeDragControls() {
            const dragHandle = document.getElementById('dragHandle');
            const circle = document.getElementById('bloodSugarCircle');

            // 鼠标事件
            dragHandle.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);

            // 触摸事件
            dragHandle.addEventListener('touchstart', startDrag, { passive: false });
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', endDrag);
        }

        function startDrag(e) {
            e.preventDefault();
            isDragging = true;
            dragStartAngle = currentAngle;

            const dragHandle = document.getElementById('dragHandle');
            dragHandle.classList.add('dragging');

            document.body.style.cursor = 'grabbing';
        }

        function drag(e) {
            if (!isDragging) return;

            e.preventDefault();

            const circle = document.getElementById('bloodSugarCircle');
            const rect = circle.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            let clientX, clientY;
            if (e.type === 'touchmove') {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            // 将数学角度转换为CSS角度（0deg=12点钟方向）
            const mathAngle = Math.atan2(clientY - centerY, clientX - centerX) * 180 / Math.PI;
            currentAngle = mathAngle + 90; // 转换为CSS角度

            // 限制角度范围（0-270度）
            if (currentAngle < 0) currentAngle = 0;
            if (currentAngle > 270) currentAngle = 270;

            updateValueFromAngle();
            updateDragHandlePosition();
        }

        function endDrag() {
            if (!isDragging) return;

            isDragging = false;
            const dragHandle = document.getElementById('dragHandle');
            dragHandle.classList.remove('dragging');

            document.body.style.cursor = 'default';
        }

        function updateValueFromAngle() {
            // 将CSS角度转换为血糖值 (0-270度 = 0.1-30.0)
            const progress = currentAngle / 270; // 0-1范围
            const value = 0.1 + progress * 29.9; // 0.1-30.0范围
            currentValue = Math.max(0.1, Math.min(30.0, value)).toFixed(1);
            updateDisplay();
        }

        function updateDragHandlePosition() {
            const dragHandle = document.getElementById('dragHandle');
            const radius = 85; // 圆点半径，适应200px容器
            const centerX = 100;
            const centerY = 100;

            // 将CSS角度（0deg=12点钟方向）转换为数学角度（0deg=3点钟方向）
            const mathAngle = (currentAngle - 90) * Math.PI / 180;
            const x = centerX + radius * Math.cos(mathAngle);
            const y = centerY + radius * Math.sin(mathAngle);

            dragHandle.style.left = x + 'px';
            dragHandle.style.top = y + 'px';
            dragHandle.style.transform = 'translate(-50%, -50%)';
        }

        function updateProgressRing() {
            const progressRing = document.getElementById('progressRing');
            const value = parseFloat(currentValue);
            const progress = (value - 0.1) / 29.9; // 0-1范围
            const degrees = progress * 270; // 0-270度

            progressRing.style.background = `conic-gradient(from 0deg, #3b82f6 0deg, #3b82f6 ${degrees}deg, #e5e7eb ${degrees}deg, #e5e7eb 360deg)`;
        }

        // 更新圆环进度（统一函数名）
        function updateCircleProgress() {
            updateProgressRing();
        }

        // 切换到手动输入
        function switchToManual() {
            // 显示手动输入内容，隐藏智能测量内容
            document.getElementById('manualContent').style.display = 'block';
            document.getElementById('smartContent').style.display = 'none';

            // 更新Tab样式
            document.getElementById('manualTab').className = 'text-blue-500 text-lg font-bold';
            document.getElementById('smartTab').className = 'text-gray-400 text-lg font-medium';

            // 显示底部保存按钮
            document.querySelector('.manual-record-btn-container').style.display = 'block';
        }

        // 切换到智能测量
        function switchToSmart() {
            // 显示智能测量内容，隐藏手动输入内容
            document.getElementById('manualContent').style.display = 'none';
            document.getElementById('smartContent').style.display = 'block';

            // 更新Tab样式
            document.getElementById('manualTab').className = 'text-gray-900 text-lg font-medium';
            document.getElementById('smartTab').className = 'text-blue-500 text-lg font-bold';

            // 隐藏底部保存按钮（智能测量不需要手动保存）
            document.querySelector('.manual-record-btn-container').style.display = 'none';

            // 如果是蓝牙标签，启动自动化流程
            const bluetoothTab = document.getElementById('bluetoothTab');
            if (bluetoothTab.classList.contains('active')) {
                startBluetoothFlow();
            }
        }

        // 启动蓝牙自动化流程
        function startBluetoothFlow() {
            // 确保是蓝牙标签且显示蓝牙设备列表
            const bluetoothList = document.getElementById('bluetoothDeviceList');
            if (bluetoothList && bluetoothList.style.display !== 'none') {
                startBluetoothFlowProcess();
            }
        }

        // 蓝牙自动化流程
        function startBluetoothFlowProcess() {
            console.log('开始蓝牙自动化流程');
            let flowStep = 0;
            let flowTimer = null;

            const flowSteps = [
                {
                    status: 'connecting',
                    message: '正在搜索设备，请稍候…',
                    duration: 3000,
                    statusText: '连接中',
                    bgClass: 'bg-blue-50 border-blue-200',
                    textClass: 'text-blue-800',
                    iconClass: 'fas fa-info-circle',
                    statusClass: 'status-connecting'
                },
                {
                    status: 'connected',
                    message: '设备连接成功！',
                    duration: 3000,
                    statusText: '连接成功',
                    bgClass: 'bg-green-50 border-green-200',
                    textClass: 'text-green-800',
                    iconClass: 'fas fa-check-circle',
                    statusClass: 'status-success'
                },
                {
                    status: 'measuring',
                    message: '正在测量血糖值，请稍候…',
                    duration: 5000,
                    statusText: '测量中',
                    bgClass: 'bg-orange-50 border-orange-200',
                    textClass: 'text-orange-800',
                    iconClass: 'fas fa-heartbeat',
                    statusClass: 'status-measuring'
                }
            ];

            function executeNextStep() {
                console.log(`执行流程步骤: ${flowStep} (${flowSteps[flowStep]?.status})`);

                // 清除之前的定时器
                if (flowTimer) {
                    clearTimeout(flowTimer);
                    flowTimer = null;
                }

                if (flowStep >= flowSteps.length) {
                    console.log('流程完成，准备重新开始');
                    // 流程完成，循环重新开始
                    flowStep = 0;
                    flowTimer = setTimeout(executeNextStep, 2000);
                    return;
                }

                const step = flowSteps[flowStep];
                console.log(`执行步骤: ${step.status}, 持续时间: ${step.duration}ms`);
                updateFlowUI(step);

                // 设置下一步的定时器 - 确保所有步骤都自动执行
                flowTimer = setTimeout(() => {
                    console.log(`步骤 ${step.status} 完成，跳转到下一步`);
                    flowStep++;
                    executeNextStep();
                }, step.duration);
            }

            function updateFlowUI(step) {
                console.log(`更新UI: ${step.status}`);
                const statusIndicator = document.getElementById('statusIndicator');
                const toastMessage = document.querySelector('.toast-message');
                const toastIcon = toastMessage.querySelector('i');
                const toastText = toastMessage.querySelector('span');
                const actionButton = document.getElementById('actionButton');

                // 更新状态指示器
                statusIndicator.className = `status-indicator ${step.statusClass}`;

                if (step.status === 'connecting') {
                    statusIndicator.innerHTML = '<div class="connecting-dots"><span></span><span></span><span></span></div><span>连接中</span>';

                    // 连接中状态 - 显示取消连接按钮
                    actionButton.innerHTML = '<i class="fas fa-times mr-2"></i>取消连接';
                    actionButton.className = 'flow-btn flow-btn-primary';
                    actionButton.onclick = cancelBluetoothConnection;

                } else if (step.status === 'connected') {
                    statusIndicator.innerHTML = '<i class="fas fa-check-circle mr-2"></i><span>连接成功</span>';

                    // 连接成功状态 - 显示开始测量按钮
                    actionButton.innerHTML = '<i class="fas fa-heartbeat mr-2"></i>开始测量';
                    actionButton.className = 'flow-btn flow-btn-primary';
                    actionButton.onclick = startMeasuring;

                } else if (step.status === 'measuring') {
                    statusIndicator.innerHTML = '<i class="fas fa-heartbeat mr-2 heartbeat-animation"></i><span>测量中</span>';

                    // 测量中状态 - 显示停止测量按钮
                    actionButton.innerHTML = '<i class="fas fa-stop mr-2"></i>停止测量';
                    actionButton.className = 'flow-btn btn-danger';
                    actionButton.onclick = stopMeasuring;
                }

                // 更新Toast消息
                toastMessage.className = `toast-message mb-6 p-4 ${step.bgClass} rounded-lg`;
                toastMessage.querySelector('div').className = `flex items-center ${step.textClass}`;
                toastIcon.className = `${step.iconClass} mr-2`;
                toastText.textContent = step.message;

                console.log(`UI更新完成: ${step.status}`);
            }

            // 开始执行流程
            executeNextStep();
        }

        // 通用按钮处理函数
        function handleAction() {
            // 这个函数会被updateFlowUI动态替换
            console.log('Action button clicked');
        }

        // 取消蓝牙连接
        function cancelBluetoothConnection() {
            if (confirm('确定要取消蓝牙连接吗？')) {
                // 显示取消连接状态
                const statusIndicator = document.getElementById('statusIndicator');
                const toastMessage = document.querySelector('.toast-message span');

                statusIndicator.className = 'status-indicator bg-red-100 text-red-600';
                statusIndicator.innerHTML = '<i class="fas fa-times-circle mr-2"></i>连接已取消';
                toastMessage.textContent = '蓝牙连接已取消';
                toastMessage.parentElement.className = 'toast-message mb-6 p-4 bg-red-50 border border-red-200 rounded-lg';
                toastMessage.parentElement.querySelector('i').className = 'fas fa-exclamation-circle mr-2';
                toastMessage.parentElement.querySelector('div').className = 'flex items-center text-red-800';

                // 2秒后恢复到原始状态
                setTimeout(() => {
                    statusIndicator.className = 'status-indicator status-connecting';
                    statusIndicator.innerHTML = '<div class="connecting-dots"><span></span><span></span><span></span></div><span>连接中</span>';
                    toastMessage.textContent = '正在搜索设备，请稍候…';
                    toastMessage.parentElement.className = 'toast-message mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg';
                    toastMessage.parentElement.querySelector('i').className = 'fas fa-info-circle mr-2';
                    toastMessage.parentElement.querySelector('div').className = 'flex items-center text-blue-800';
                }, 2000);
            }
        }

        // 开始测量
        function startMeasuring() {
            console.log('开始测量');
            // 可以在这里添加开始测量的逻辑
            // 比如直接跳转到测量状态
            const measuringStep = {
                status: 'measuring',
                message: '正在测量血糖值，请稍候…',
                duration: 5000,
                statusText: '测量中',
                bgClass: 'bg-orange-50 border-orange-200',
                textClass: 'text-orange-800',
                iconClass: 'fas fa-heartbeat',
                statusClass: 'status-measuring'
            };
            updateFlowUI(measuringStep);
        }

        // 停止测量
        function stopMeasuring() {
            if (confirm('确定要停止测量吗？')) {
                console.log('停止测量');
                // 可以在这里添加停止测量的逻辑
                // 比如返回到连接成功状态
                const connectedStep = {
                    status: 'connected',
                    message: '设备连接成功！',
                    duration: 3000,
                    statusText: '连接成功',
                    bgClass: 'bg-green-50 border-green-200',
                    textClass: 'text-green-800',
                    iconClass: 'fas fa-check-circle',
                    statusClass: 'status-success'
                };
                updateFlowUI(connectedStep);
            }
        }

        // 导航到设备详情页
        function navigateToDeviceDetail(event, deviceType) {
            // 阻止事件冒泡，避免触发绑定/解绑操作
            event.stopPropagation();

            // 检查设备是否已绑定
            const card = event.currentTarget;
            const button = card.querySelector('button[onclick*="connectDevice"]');
            const isBound = button.classList.contains('disconnect');

            if (!isBound) {
                // 如果设备未绑定，提示用户先绑定设备
                alert('请先绑定设备后再查看详情');
                return;
            }

            // 跳转到设备详情页
            console.log('导航到设备详情页:', deviceType);
            alert(`跳转到${deviceType}设备详情页（功能开发中）`);
        }

        // 连接设备
        function connectDevice(deviceType) {
            // 获取正确的按钮元素（可能是event.target或其父元素）
            let button = event.target;
            while (button && button.tagName !== 'BUTTON') {
                button = button.parentElement;
            }

            if (!button) return;

            const originalText = button.innerHTML;

            if (!button.classList.contains('disconnect')) {
                // 未绑定设备 - 跳转到扫码绑定页面，并传递from参数
                window.location.href = 'device-qr-scan.html?from=blood-sugar';
            } else {
                // 如果是已绑定状态，点击后直接解绑
                if (confirm('确定要解除绑定该设备吗？')) {
                    // 显示解绑中状态
                    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>解绑中...';
                    button.disabled = true;

                    setTimeout(() => {
                        // 更新为未绑定状态
                        button.innerHTML = '<i class="fas fa-link mr-1"></i>绑定设备';
                        button.classList.remove('disconnect');

                        // 更新卡片状态
                        const card = button.closest('.device-card');
                        card.classList.remove('connected');
                        card.classList.add('unconnected');

                        // 启用按钮
                        button.disabled = false;

                        alert('设备已解除绑定！');
                    }, 800);
                }
            }
        }

        // 切换设备类型
        function switchDeviceType(type) {
            // 更新标签样式
            const bluetoothTab = document.getElementById('bluetoothTab');
            const gprsTab = document.getElementById('gprsTab');
            const bluetoothList = document.getElementById('bluetoothDeviceList');
            const gprsList = document.getElementById('gprsDeviceList');

            if (type === 'bluetooth') {
                // 蓝牙血糖仪标签 - 选中状态
                bluetoothTab.className = 'device-type-item active';
                gprsTab.className = 'device-type-item';

                // 显示蓝牙设备列表，隐藏4G设备列表
                bluetoothList.style.display = 'block';
                gprsList.style.display = 'none';

                // 启动蓝牙自动化流程
                setTimeout(() => {
                    startBluetoothFlowProcess();
                }, 500);
            } else {
                // 4G血糖仪标签 - 选中状态
                gprsTab.className = 'device-type-item active';
                bluetoothTab.className = 'device-type-item';

                // 显示4G设备列表，隐藏蓝牙设备列表
                gprsList.style.display = 'block';
                bluetoothList.style.display = 'none';
            }
        }

  
        
        // 联系客服
        function contactCustomerService() {
            // 模拟联系客服功能
            const customerServicePhone = '400-123-4567';
            const customerServiceTime = '工作日 9:00-18:00';

            if (confirm(`客服电话：${customerServicePhone}\n服务时间：${customerServiceTime}\n\n是否拨打电话联系客服？`)) {
                // 在实际应用中，这里可以调用拨号功能
                alert(`正在拨打客服电话：${customerServicePhone}`);
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>