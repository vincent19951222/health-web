<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>健康档案 - 优唐智能AI+</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ----- 视觉系统定义 ----- */
        :root {
            /* 蓝色主色调 (参考 profile.html) */
            --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            --color-primary: #3b82f6;
            /* 蓝 */
            --color-accent: #f59e0b;
            /* 橙 */
            --color-success: #10b981;

            --bg-page: #f9fafb;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --text-main: #1f2937;
            --text-sub: #6b7280;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-page);
            color: var(--text-main);
            padding-bottom: 40px;
            -webkit-tap-highlight-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* ----- 1. 沉浸式 Header ----- */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            box-shadow: 0 1px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            font-size: 18px;
            transition: background 0.2s;
        }

        .back-btn:active {
            background: #edf2f7;
            transform: scale(0.95);
        }

        .header-title {
            font-weight: 700;
            font-size: 17px;
            color: var(--text-main);
        }

        /* ----- 2. 游戏化仪表盘 (Dashboard) ----- */
        .dashboard-header {
            background: var(--gradient-primary);
            padding: 30px 20px 40px;
            /* Adjusted padding */
            border-radius: 0;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(15, 76, 129, 0.2);
        }

        /* 装饰背景圆环 */
        .bg-circle {
            position: absolute;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .stats-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .stats-text h2 {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .stats-text p {
            font-size: 13px;
            opacity: 0.9;
        }

        /* 环形进度条 */
        .circular-chart {
            display: block;
            margin: 0;
            max-width: 80px;
            max-height: 80px;
        }

        .circle-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 3.8;
        }

        .circle {
            fill: none;
            stroke-width: 3.8;
            stroke-linecap: round;
            stroke: var(--color-accent);
            /* 橙色进度条 */
            animation: progress 1s ease-out forwards;
        }

        @keyframes progress {
            0% {
                stroke-dasharray: 0 100;
            }
        }

        .percentage {
            fill: white;
            font-family: sans-serif;
            font-weight: bold;
            font-size: 0.5em;
            text-anchor: middle;
        }

        /* ----- 3. Bento Grid (便当盒) ----- */
        .bento-grid {
            padding: 20px;
            margin-top: -30px;
            /* 向上重叠 */
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        /* 某些卡片跨两列 */
        .col-span-2 {
            grid-column: span 2;
        }

        .bento-card {
            background: white;
            border-radius: 20px;
            padding: 16px;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .bento-card:active {
            transform: scale(0.96);
        }

        .card-icon-bg {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: #edf2f7;
            color: var(--color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .card-desc {
            font-size: 11px;
            color: var(--text-sub);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        /* 卡片内进度条 */
        .mini-progress-track {
            height: 4px;
            background: #edf2f7;
            border-radius: 2px;
            overflow: hidden;
        }

        .mini-progress-bar {
            height: 100%;
            background: var(--color-success);
            border-radius: 2px;
            width: 0%;
            transition: width 0.5s ease;
        }

        .status-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #cbd5e0;
        }

        .status-badge.completed {
            background: var(--color-success);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }

        /* ----- 4. 详情页 & 胶囊选项 (Capsule UI) ----- */
        .detail-view {
            display: none;
            padding-top: 0px;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* 吸附式进度提示 */
        .sticky-progress {
            position: sticky;
            top: 56px;
            z-index: 40;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            padding: 10px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-sub);
        }

        .section-container {
            padding: 20px;
        }

        .question-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.02);
            border: 1px solid #f0f0f0;
        }

        .q-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 16px;
        }

        /* 胶囊选项组 */
        .capsule-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .capsule-option {
            position: relative;
            cursor: pointer;
        }

        .capsule-option input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .capsule-content {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #f7fafc;
            border: 1px solid #edf2f7;
            border-radius: 50px;
            /* 全圆角 */
            color: var(--text-sub);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* 选中态：变橙色 (副色调)，微放大 */
        .capsule-option input:checked+.capsule-content {
            background: #fff7ed;
            border-color: var(--color-accent);
            color: #c2410c;
            box-shadow: 0 4px 12px rgba(255, 159, 67, 0.2);
            transform: scale(1.05);
        }

        .capsule-content i {
            font-size: 14px;
        }

        /* 输入框样式优化 */
        .modern-input {
            width: 100%;
            padding: 12px 16px;
            background: #f7fafc;
            border: 1px solid #edf2f7;
            border-radius: 12px;
            font-size: 15px;
            color: var(--text-main);
            transition: all 0.2s;
        }

        .modern-input:focus {
            background: white;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(15, 76, 129, 0.1);
            outline: none;
        }

        /* 底部浮动按钮 */
        .bottom-action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(to top, white 80%, transparent);
            z-index: 50;
            display: none;
            /* JS控制显示 */
        }

        .btn-complete {
            width: 100%;
            padding: 14px;
            background: var(--gradient-primary);
            color: white;
            font-weight: 700;
            font-size: 16px;
            border-radius: 16px;
            border: none;
            box-shadow: 0 10px 20px rgba(15, 76, 129, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s;
        }

        .btn-complete:active {
            transform: scale(0.98);
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <!-- 顶部导航栏 (新增) -->
    <div class="bg-white shadow-sm fixed top-0 left-0 right-0 z-50 h-[56px] flex items-center justify-between px-4"
        id="main-header">
        <button onclick="handleBack()"
            class="text-gray-600 hover:text-gray-800 w-10 h-10 flex items-center justify-center -ml-2">
            <i class="fas fa-chevron-left text-lg"></i>
        </button>
        <h1 class="text-lg font-semibold text-gray-800 absolute left-1/2 transform -translate-x-1/2" id="page-title">
            健康档案</h1>
        <div class="w-10"></div> <!-- 占位符保持居中 -->
    </div>
    <div class="h-[56px]"></div> <!-- Header Placeholder -->

    <!-- View 1: Dashboard (游戏化仪表盘) -->
    <div id="view-dashboard">
        <!-- 顶部装饰背景 -->
        <div class="dashboard-header">
            <div class="bg-circle" style="width: 200px; height: 200px; top: -50px; right: -50px; opacity: 0.1;"></div>
            <div class="bg-circle" style="width: 100px; height: 100px; bottom: 20px; left: 10%; opacity: 0.05;"></div>

            <div class="stats-container">
                <div class="stats-text">
                    <h2>下午好，User</h2>
                    <p>完善档案，解锁 AI 深度评估</p>
                    <p class="mt-2 text-xs bg-white/10 inline-block px-2 py-1 rounded-lg">
                        <i class="fas fa-trophy text-yellow-300 mr-1"></i> 已超越 12% 的用户
                    </p>
                </div>
                <!-- 环形进度条 -->
                <svg viewBox="0 0 36 36" class="circular-chart">
                    <path class="circle-bg"
                        d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <path class="circle" id="global-circle" stroke-dasharray="0, 100"
                        d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <text x="18" y="20.35" class="percentage" id="global-text">0%</text>
                </svg>
            </div>
        </div>

        <!-- 便当盒网格 -->
        <div class="bento-grid">
            <!-- 1. 基本信息 -->
            <div class="bento-card" onclick="openSection(1)">
                <div class="status-badge" id="badge-1"></div>
                <div class="card-icon-bg"><i class="fas fa-id-card-alt"></i></div>
                <div class="card-title">1. 基本信息</div>
                <div class="card-desc">建立您的数字健康身份 ID</div>
                <div class="mini-progress-track mt-3">
                    <div class="mini-progress-bar" id="prog-1"></div>
                </div>
            </div>

            <!-- 2. 个人疾病 -->
            <div class="bento-card" onclick="openSection(2)">
                <div class="status-badge" id="badge-2"></div>
                <div class="card-icon-bg text-red-500 bg-red-50"><i class="fas fa-heartbeat"></i></div>
                <div class="card-title">2. 疾病信息</div>
                <div class="card-desc">既往病史与症状</div>
                <div class="mini-progress-track mt-3">
                    <div class="mini-progress-bar" id="prog-2"></div>
                </div>
            </div>

            <!-- 3. 健康工具 -->
            <div class="bento-card" onclick="openSection(3)">
                <div class="status-badge" id="badge-3"></div>
                <div class="card-icon-bg text-green-500 bg-green-50"><i class="fas fa-box-open"></i></div>
                <div class="card-title">3. 健康工具</div>
                <div class="card-desc">保健品/器械</div>
                <div class="mini-progress-track mt-3">
                    <div class="mini-progress-bar" id="prog-3"></div>
                </div>
            </div>

            <!-- 4. 用药信息 -->
            <div class="bento-card" onclick="openSection(4)">
                <div class="status-badge" id="badge-4"></div>
                <div class="card-icon-bg text-blue-500 bg-blue-50"><i class="fas fa-capsules"></i></div>
                <div class="card-title">4. 用药信息</div>
                <div class="card-desc">当前服用的药物</div>
                <div class="mini-progress-track mt-3">
                    <div class="mini-progress-bar" id="prog-4"></div>
                </div>
            </div>

            <!-- 5. 关注的健康问题 -->
            <div class="bento-card" onclick="openSection(5)">
                <div class="status-badge" id="badge-5"></div>
                <div class="card-icon-bg mb-0 bg-yellow-50 text-yellow-600"><i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="card-title mt-3">5. 关注的健康问题</div>
                <div class="card-desc">您的健康困扰</div>
                <div class="mini-progress-track mt-3">
                    <div class="mini-progress-bar" id="prog-5"></div>
                </div>
            </div>

            <!-- 6. 期望的健康目标 -->
            <div class="bento-card" onclick="openSection(6)">
                <div class="status-badge" id="badge-6"></div>
                <div class="card-icon-bg mb-0 bg-indigo-50 text-indigo-500"><i class="fas fa-bullseye"></i></div>
                <div class="card-title mt-3">6. 期望的健康目标</div>
                <div class="card-desc">您的健康期许</div>
                <div class="mini-progress-track mt-3">
                    <div class="mini-progress-bar" id="prog-6"></div>
                </div>
            </div>

            <!-- 7. 生活行为习惯 -->
            <div class="bento-card" onclick="openSection(7)">
                <div class="status-badge" id="badge-7"></div>
                <div class="card-icon-bg text-purple-500 bg-purple-50"><i class="fas fa-running"></i></div>
                <div class="card-title">7. 生活行为习惯</div>
                <div class="card-desc">吸烟/饮酒/运动</div>
                <div class="mini-progress-track mt-3">
                    <div class="mini-progress-bar" id="prog-7"></div>
                </div>
            </div>

            <!-- 8. 膳食调查 -->
            <div class="bento-card" onclick="openSection(8)">
                <div class="status-badge" id="badge-8"></div>
                <div class="card-icon-bg text-orange-500 bg-orange-50"><i class="fas fa-utensils"></i></div>
                <div class="card-title">8. 膳食调查</div>
                <div class="card-desc">饮食习惯分析</div>
                <div class="mini-progress-track mt-3">
                    <div class="mini-progress-bar" id="prog-8"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- View 2: Detail Form Container -->
    <div id="view-detail" class="detail-view">
        <div class="sticky-progress flex-col !items-stretch !justify-center gap-1">
            <div class="flex justify-between items-center w-full">
                <span class="text-sm text-gray-600">正在填写：<strong id="section-name-display"
                        class="text-gray-900">基本信息</strong></span>
                <span id="section-progress-text" class="text-xs font-bold text-blue-600">0%</span>
            </div>
            <div class="w-full bg-gray-100 rounded-full h-1.5 mt-0.5">
                <div id="section-progress-bar" class="bg-blue-600 h-1.5 rounded-full transition-all duration-300"
                    style="width: 0%"></div>
            </div>
        </div>

        <div class="section-container">
            <form id="detail-form" onsubmit="return false;">
                <!-- Content injected dynamically -->
            </form>
            <div style="height: 80px;"></div> <!-- Spacer for bottom button -->
        </div>

        <div class="bottom-action-bar" id="bottom-bar">
            <button class="btn-complete" onclick="handleBack()">
                <span>完成本节</span> <i class="fas fa-check-circle"></i>
            </button>
        </div>
    </div>

    <script>
        // ----- 全局状态 -----
        const PROFILES_KEY = 'health_profiles_list';
        let currentProfileId = null;
        let currentView = 'dashboard';
        let currentSectionId = 0;
        let currentSubTab = 0; // State for Section 2 Tabs
        let healthData = {
            section_1: {}, section_2: {}, section_3: [], section_4: [],
            section_5: '', section_6: '', section_7: {}, section_8: {}
        };

        // ----- 初始化 -----
        document.addEventListener('DOMContentLoaded', () => {
            // 解析 URL 参数获取档案 ID
            const urlParams = new URLSearchParams(window.location.search);
            currentProfileId = urlParams.get('id');

            if (currentProfileId) {
                // 从档案列表中加载指定档案
                const profiles = JSON.parse(localStorage.getItem(PROFILES_KEY) || '[]');
                const profile = profiles.find(p => p.id === currentProfileId);
                if (profile && profile.data) {
                    healthData = profile.data;
                }
            } else {
                // 兼容旧版：如果没有 ID 参数，尝试加载旧格式数据
                const saved = localStorage.getItem('health_profile_detailed_v5');
                if (saved) healthData = JSON.parse(saved);
            }

            updateGlobalProgress();
        });

        // ----- 导航逻辑 -----
        function handleBack() {
            if (currentView === 'detail') {
                // 如果是 Section 2 且处于子 Tab 1/2/3，处理为“上一步”而不是退出 (可选体验，暂不开启以保持 Back 按钮行为一致)
                // 这里我们修改 handleBack 主要用于处理“完成本节”按钮的逻辑重载
                // 但注意，底部按钮现在可能会调用 switchSubTab(next) 

                saveData();
                const dashboard = document.getElementById('view-dashboard');
                const detail = document.getElementById('view-detail');
                const bottomBar = document.getElementById('bottom-bar');

                // 动画退出
                detail.style.opacity = '0';
                detail.style.transform = 'translateY(20px)';

                setTimeout(() => {
                    detail.style.display = 'none';
                    detail.style.opacity = '1'; // Reset
                    detail.style.transform = 'translateY(0)';

                    bottomBar.style.display = 'none';
                    dashboard.classList.remove('hidden');
                    currentView = 'dashboard';
                    updateGlobalProgress();

                    // Reset Title
                    document.getElementById('page-title').innerText = '健康档案';
                }, 200);
            } else {
                // 从 dashboard 视图返回到列表页
                saveData();
                if (window.parent !== window) {
                    window.parent.postMessage({ type: 'navigate', page: 'health_profile_list' }, '*');
                }
                window.location.href = 'health_profile_list.html';
            }
        }

        // 处理底部按钮点击
        function handleBottomAction() {
            if (currentSectionId === 2) {
                if (currentSubTab < 3) {
                    switchSubTab(currentSubTab + 1);
                    return;
                }
            }
            handleBack(); // 完成本节
        }

        function openSection(id) {
            currentSectionId = id;
            currentSubTab = 0; // Reset sub tab

            const dashboard = document.getElementById('view-dashboard');
            const detail = document.getElementById('view-detail');
            const bottomBar = document.getElementById('bottom-bar');

            dashboard.classList.add('hidden');
            bottomBar.style.display = 'block';

            detail.style.display = 'block';

            // 设置标题
            const titles = {
                1: '1. 基本信息', 2: '2. 疾病信息', 3: '3. 健康工具', 4: '4. 用药信息',
                5: '5. 关注的健康问题', 6: '6. 期望的健康目标', 7: '7. 生活行为习惯', 8: '8. 膳食调查'
            };
            document.getElementById('page-title').innerText = titles[id] || '详情';
            document.getElementById('section-name-display').innerText = titles[id] || '';

            renderSectionForm(id);
            currentView = 'detail';
            updateCurrentSectionUI(); // Initialize progress bar
            window.scrollTo(0, 0);

            // Reset Bottom Button Text
            const btnSpan = document.querySelector('#bottom-bar span');
            if (btnSpan) btnSpan.innerText = '完成本节';
            // Update onclick handler
            const btn = document.querySelector('#bottom-bar button');
            if (btn) btn.onclick = handleBottomAction;
        }

        // ----- Section 2 Sub-Tabs Logic -----
        function switchSubTab(index) {
            currentSubTab = index;
            // 1. Hide all sub-views, show target
            for (let i = 0; i < 4; i++) {
                const el = document.getElementById(`sub-view-${i}`);
                if (el) {
                    if (i === index) {
                        el.classList.remove('hidden');
                        el.style.display = 'block'; // Force display
                    } else {
                        el.classList.add('hidden');
                        el.style.display = 'none'; // Force hide
                    }
                }
            }

            // 2. Update Tab Styles
            for (let i = 0; i < 4; i++) {
                const btn = document.getElementById(`sub-tab-${i}`);
                if (btn) {
                    if (i === index) {
                        btn.classList.remove('bg-transparent', 'border-transparent');
                        btn.classList.add('bg-white', 'border-gray-200', 'shadow-sm', 'text-blue-600');
                    } else {
                        btn.classList.add('bg-transparent', 'border-transparent');
                        btn.classList.remove('bg-white', 'border-gray-200', 'shadow-sm', 'text-blue-600');
                    }
                }
            }

            // 3. Scroll tabs into view if needed
            const tabContainer = document.getElementById('section-2-tabs');
            const targetTab = document.getElementById(`sub-tab-${index}`);
            if (tabContainer && targetTab) {
                const offset = targetTab.offsetLeft - tabContainer.offsetLeft - 20;
                tabContainer.scrollTo({ left: offset, behavior: 'smooth' });
            }

            // 4. Update Bottom Button
            const btnSpan = document.querySelector('#bottom-bar span');
            const btnIcon = document.querySelector('#bottom-bar i');
            if (index < 3) {
                if (btnSpan) btnSpan.innerText = '下一步';
                if (btnIcon) btnIcon.className = 'fas fa-arrow-right';
            } else {
                if (btnSpan) btnSpan.innerText = '完成本节';
                if (btnIcon) btnIcon.className = 'fas fa-check-circle';
            }

            // Scroll to top of content
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        window.switchSubTab = switchSubTab;

        // ----- UI 组件生成器 (Capsule UI) -----

        // 生成胶囊单选/多选
        function renderCapsules(name, type, options, selectedValues = []) {
            let html = `<div class="capsule-group">`;
            options.forEach(opt => {
                const val = opt.value;
                const label = opt.label;
                const icon = opt.icon || (type === 'radio' ? 'fa-check' : 'fa-plus');
                const isChecked = selectedValues.includes(val) ? 'checked' : '';

                html += `
                    <label class="capsule-option">
                        <input type="${type}" name="${name}" value="${val}" class="input-field" ${isChecked}>
                        <div class="capsule-content">
                            <i class="fas ${icon}"></i> <span>${label}</span>
                        </div>
                    </label>
                `;
            });
            html += `</div>`;
            return html;
        }

        // ----- 常量定义 -----
        const ETHNICITIES = [
            "汉族", "蒙古族", "回族", "藏族", "维吾尔族", "苗族", "彝族", "壮族", "布依族",
            "朝鲜族", "满族", "侗族", "瑶族", "白族", "土家族", "哈尼族", "哈萨克族", "傣族",
            "黎族", "傈僳族", "佤族", "畲族", "高山族", "拉祜族", "水族", "东乡族", "纳西族",
            "景颇族", "柯尔克孜族", "土族", "达斡尔族", "仫佬族", "羌族", "布朗族", "撒拉族",
            "毛南族", "仡佬族", "锡伯族", "阿昌族", "普米族", "塔吉克族", "怒族", "乌孜别克族",
            "俄罗斯族", "鄂温克族", "德昂族", "保安族", "裕固族", "京族", "塔塔尔族", "独龙族",
            "鄂伦春族", "赫哲族", "门巴族", "珞巴族", "基诺族"
        ];

        const RELATIONSHIPS = ['配偶', '父母', '子女', '兄弟姐妹', '亲戚', '朋友', '同事', '其他'];

        // ----- 工具函数 -----
        function maskIdCard(val) {
            if (!val || val.length < 8) return val;
            return val.substring(0, val.length - 4).replace(/./g, '*') + val.substring(val.length - 4);
        }

        // ----- 渲染表单逻辑 -----
        function renderSectionForm(id) {
            const container = document.getElementById('detail-form');
            let html = '';

            if (id === 1) {
                const d = healthData.section_1 || {};
                html += renderQuestionCard('1. 性别',
                    renderCapsules('gender', 'radio', [
                        { value: 'male', label: '男', icon: 'fa-mars' },
                        { value: 'female', label: '女', icon: 'fa-venus' }
                    ], [d.gender])
                );

                html += `<div id="field-pregnancy" class="${d.gender === 'female' ? '' : 'hidden'}">`;
                html += renderQuestionCard('2. 是否处于孕期/哺乳期',
                    renderCapsules('pregnancy', 'radio', [
                        { value: 'no', label: '否', icon: 'fa-times' },
                        { value: 'yes', label: '是', icon: 'fa-baby' }
                    ], [d.pregnancy])
                );
                html += `</div>`;

                html += renderQuestionCard('3. 民族', renderSelect('ethnicity', ETHNICITIES, d.ethnicity, '请选择民族'));

                html += renderQuestionCard('4. 籍贯', `<input type="text" class="modern-input input-field" data-key="native_place" value="${d.native_place || ''}" placeholder="请输入籍贯">`);

                html += renderQuestionCard('5. 出生日期', `<input type="date" class="modern-input input-field" data-key="dob" value="${d.dob || ''}">`);

                html += renderQuestionCard('6. 身份证号', `
                    <input type="text" class="modern-input input-field" data-key="id_card" 
                        value="${maskIdCard(d.id_card || '')}" 
                        placeholder="请输入身份证号码" maxlength="18"
                        onfocus="this.value = healthData.section_1.id_card || ''"
                        onblur="this.value = maskIdCard(healthData.section_1.id_card || '')">
                `);

                html += renderQuestionCard('7. 本人联系方式', `
                    <div class="flex flex-col gap-3">
                        <input type="tel" class="modern-input input-field" data-key="contact_1" value="${d.contact_1 || ''}" placeholder="① 主要联系方式">
                        <input type="tel" class="modern-input input-field" data-key="contact_2" value="${d.contact_2 || ''}" placeholder="② 备用联系方式 (选填)">
                    </div>
                `);

                html += renderQuestionCard('8. 紧急联系人及联系电话', `
                    <div class="flex flex-col gap-4">
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <div class="text-xs font-bold text-gray-500 mb-2">第一紧急联系人</div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <input type="text" class="modern-input input-field" data-key="emergency_1_name" value="${d.emergency_1_name || ''}" placeholder="姓名">
                                ${renderSelect('emergency_1_rel', RELATIONSHIPS, d.emergency_1_rel, '关系')}
                            </div>
                            <input type="tel" class="modern-input input-field" data-key="emergency_1_phone" value="${d.emergency_1_phone || ''}" placeholder="联系电话">
                        </div>
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <div class="text-xs font-bold text-gray-500 mb-2">第二紧急联系人</div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <input type="text" class="modern-input input-field" data-key="emergency_2_name" value="${d.emergency_2_name || ''}" placeholder="姓名">
                                ${renderSelect('emergency_2_rel', RELATIONSHIPS, d.emergency_2_rel, '关系')}
                            </div>
                            <input type="tel" class="modern-input input-field" data-key="emergency_2_phone" value="${d.emergency_2_phone || ''}" placeholder="联系电话">
                        </div>
                    </div>
                `);

                html += renderQuestionCard('9. 家庭住址 (居住6个月以上)', `
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" class="modern-input input-field" data-key="address_province" value="${d.address_province || ''}" placeholder="省/自治区">
                        <input type="text" class="modern-input input-field" data-key="address_city" value="${d.address_city || ''}" placeholder="市">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" class="modern-input input-field" data-key="address_district" value="${d.address_district || ''}" placeholder="区/县">
                        <input type="text" class="modern-input input-field" data-key="address_street" value="${d.address_street || ''}" placeholder="街道/乡镇">
                    </div>
                `);

                html += renderQuestionCard('10. 婚姻状况',
                    renderCapsules('marital', 'radio', [
                        { value: 'unmarried', label: '未婚' }, { value: 'married', label: '已婚' },
                        { value: 'divorced', label: '离异' }, { value: 'widowed', label: '丧偶' }
                    ], [d.marital])
                );

                html += renderQuestionCard('11. 居住情况',
                    renderCapsules('living_situation', 'radio', [
                        { value: 'alone', label: '独居' }, { value: 'spouse', label: '夫妻同住' },
                        { value: 'children', label: '与儿女合住' }, { value: 'nursing_home', label: '养老院居住' },
                        { value: 'other', label: '其他' }
                    ], [d.living_situation])
                );

                html += renderQuestionCard('12. 文化程度',
                    renderCapsules('education', 'radio', [
                        { value: 'none', label: '未上学' }, { value: 'primary', label: '小学' },
                        { value: 'junior', label: '初中' }, { value: 'senior', label: '高中/中专' },
                        { value: 'college', label: '大专/本科' }, { value: 'graduate', label: '研究生及以上' }
                    ], [d.education])
                );

                html += renderQuestionCard('13. 目前任职状态',
                    renderCapsules('employment_status', 'radio', [
                        { value: 'employed', label: '在职' }, { value: 'retired', label: '离退休' }
                    ], [d.employment_status])
                );

                html += renderQuestionCard('14. (原)工作单位及工作岗位',
                    `<input type="text" class="modern-input input-field" data-key="work_unit" value="${d.work_unit || ''}" placeholder="请输入单位及岗位">`
                );

                html += renderQuestionCard('15. 月收入范围',
                    renderCapsules('income', 'radio', [
                        { value: 'l2000', label: '≤2000' }, { value: '2000_4000', label: '2k-4k' },
                        { value: '4000_8000', label: '4k-8k' }, { value: 'gt8000', label: '>8k' }
                    ], [d.income])
                );
            }
            else if (id === 2) {
                const d = healthData.section_2 || {};
                const makeOpts = (arr) => arr.map(s => ({ value: s, label: s }));

                // --- Tab Navigation ---
                html += `
                    <div class="flex overflow-x-auto no-scrollbar gap-3 mb-6 sticky top-[115px] z-30 bg-gray-50/95 backdrop-blur py-2 -mx-5 px-5 border-b border-gray-200" id="section-2-tabs">
                        <button type="button" onclick="window.switchSubTab(0)" class="sub-tab-btn whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-bold transition-all bg-white text-gray-500 border border-gray-200" id="sub-tab-0">既往病史</button>
                        <button type="button" onclick="window.switchSubTab(1)" class="sub-tab-btn whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-bold transition-all bg-transparent text-gray-500 border border-transparent" id="sub-tab-1">过敏史</button>
                        <button type="button" onclick="window.switchSubTab(2)" class="sub-tab-btn whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-bold transition-all bg-transparent text-gray-500 border border-transparent" id="sub-tab-2">手术史与外伤史</button>
                        <button type="button" onclick="window.switchSubTab(3)" class="sub-tab-btn whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-bold transition-all bg-transparent text-gray-500 border border-transparent" id="sub-tab-3">家族史</button>
                    </div>
                `;

                // --- Sub-View 0: 既往病史 (9大系统) ---
                html += `<div id="sub-view-0" class="sub-view block animation-fade">`;
                const systems = [
                    {
                        key: 'circulatory', name: '循环系统', icon: 'fa-heartbeat', color: 'text-red-500',
                        diseases: ['高血压', '脑卒中（脑梗/腔梗/出血性）', '心肌缺血', '冠心病', '动脉粥样硬化', '肺心病', '人工心脏起搏', '静脉曲张'],
                        symptoms: ['头痛', '头晕', '心慌', '胸闷', '活动气促', '下肢水肿', '心前区疼痛', '心律不齐', '早搏', '房颤', '心悸', '四肢冰凉']
                    },
                    {
                        key: 'respiratory', name: '呼吸系统', icon: 'fa-lungs', color: 'text-blue-500',
                        diseases: ['老慢支', '肺气肿', '肺癌', '呼吸暂停综合症', '咽炎', '肺结核', '慢阻肺', '哮喘', '支气管扩张', '肺纤维化'],
                        symptoms: ['咳嗽', '咳痰', '咯血', '呼吸困难', '气喘', '气短', '嘴唇紫绀']
                    },
                    {
                        key: 'immune', name: '免疫系统', icon: 'fa-shield-virus', color: 'text-green-500',
                        diseases: ['类风湿性关节炎', '风心病', '凝血功能下降', '白细胞减少症', '系统性红斑狼疮', '带状疱疹', '湿疹', '过敏性哮喘'],
                        symptoms: ['易感冒', '畏寒怕冷', '淋巴结肿大', '精神状态差', '皮肤瘙痒']
                    },
                    {
                        key: 'nervous', name: '神经系统', icon: 'fa-brain', color: 'text-purple-500',
                        diseases: ['神经性头痛', '帕金森氏综合症', '神经性皮炎', '脑萎缩', '阿尔茨海默综合症', '神经衰弱', '美尼尔氏综合症'],
                        symptoms: ['记忆力减退', '反应迟缓', '全身无力', '肢体震颤', '感官功能障碍', '平衡功能障碍']
                    },
                    {
                        key: 'motor', name: '运动系统', icon: 'fa-bone', color: 'text-orange-500',
                        diseases: ['既往骨折史', '骨质疏松', '坐骨神经痛', '关节炎', '肩周炎', '关节腔积液', '骨质增生', '股骨头坏死', '腰椎病', '颈椎病'],
                        symptoms: ['关节疼痛', '关节红肿', '关节变形', '肌肉痛', '骨刺', '肌肉萎缩', '颈椎疼痛', '脊柱变形']
                    },
                    {
                        key: 'digestive', name: '消化系统', icon: 'fa-utensils', color: 'text-yellow-500',
                        diseases: ['慢性肝炎', '脂肪肝', '肝囊肿', '药物性肝病', '肝癌', '胆结石', '慢性胃炎', '胃溃疡', '胃癌', '肠易激综合征', '肠癌', '胰腺炎'],
                        symptoms: ['食欲减退', '反酸', '恶心', '呕吐', '腹胀', '吸收障碍', '腹痛', '腹泻', '便血', '便秘']
                    },
                    {
                        key: 'endocrine', name: '内分泌系统', icon: 'fa-dna', color: 'text-pink-500',
                        diseases: ['糖尿病（Ⅰ型/Ⅱ型）', '血脂异常', '痛风/高尿酸血症', '贫血', '甲状腺结节', '甲状腺肿瘤', '甲亢', '甲减'],
                        symptoms: ['体重增加', '体重减轻', '饥饿感', '面色苍白', '面色潮红']
                    },
                    {
                        key: 'urogenital', name: '泌尿生殖系统', icon: 'fa-venus-mars', color: 'text-indigo-500',
                        diseases: ['肾炎', '肾结石', '肾囊肿', '泌尿生殖感染', '输尿管结石'], // 基础疾病
                        symptoms: ['尿频', '尿急', '尿痛', '夜尿频多']
                    },
                    {
                        key: 'sensory', name: '感官系统', icon: 'fa-eye', color: 'text-teal-500',
                        diseases: ['耳聋/耳鸣', '视网膜脱落', '白内障', '青光眼', '黄斑变性'],
                        symptoms: ['听力下降', '视力下降', '味觉退化', '嗅觉退化', '感觉迟缓']
                    }
                ];

                systems.forEach(sys => {
                    let diseases = sys.diseases;
                    if (sys.key === 'urogenital') {
                        const gender = (healthData.section_1 && healthData.section_1.gender) || '';
                        if (gender === 'male') {
                            diseases = diseases.concat(['前列腺疾病史（前列腺炎/前列腺肥大）', '前列腺癌']);
                        } else if (gender === 'female') {
                            diseases = diseases.concat(['良性乳腺疾病史', '乳腺癌', '子宫肌瘤', '卵巢囊肿']);
                        } else {
                            diseases = diseases.concat(['前列腺疾病(男)', '乳腺疾病(女)', '子宫/卵巢疾病(女)']);
                        }
                    }

                    html += `
                        <div class="question-card">
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center ${sys.color}">
                                    <i class="fas ${sys.icon}"></i>
                                </div>
                                <div class="q-title mb-0">${sys.name}</div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">诊断疾病</div>
                                ${renderCapsules(sys.key + '_diseases', 'checkbox', makeOpts(diseases), d[sys.key + '_diseases'])}
                                <input type="text" class="modern-input mt-2" placeholder="其他疾病..." 
                                    data-key="${sys.key}_diseases_other" value="${d[sys.key + '_diseases_other'] || ''}">
                            </div>
                            
                            <div>
                                <div class="text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">自觉症状</div>
                                ${renderCapsules(sys.key + '_symptoms', 'checkbox', makeOpts(sys.symptoms), d[sys.key + '_symptoms'])}
                                <input type="text" class="modern-input mt-2" placeholder="其他症状..." 
                                    data-key="${sys.key}_symptoms_other" value="${d[sys.key + '_symptoms_other'] || ''}">
                            </div>
                        </div>
                    `;
                });
                html += `</div>`; // End sub-view-0

                // --- Sub-View 1: 过敏史 ---
                html += `<div id="sub-view-1" class="sub-view hidden animation-fade">`;
                const allergyOpts = ['青霉素', '头孢菌素类', '喹诺酮类药物', '磺胺类药物', '替硝唑', '甲硝唑', '链霉素', '异种血清', '化妆品', '染发剂', '花粉', '柳絮', '化纤用品', '牛奶', '乳糖不耐受', '鸡蛋', '麸质', '螃蟹', '虾'];
                html += renderQuestionCard('过敏史',
                    `<div class="text-sm text-gray-500 mb-4">请选择您已知的所有过敏源：</div>` +
                    renderCapsules('allergies', 'checkbox', makeOpts(allergyOpts), d.allergies) +
                    `<input type="text" class="modern-input mt-3" placeholder="其他过敏源..." data-key="allergies_other" value="${d.allergies_other || ''}">`
                );
                html += `</div>`;

                // --- Sub-View 2: 手术与外伤 ---
                html += `<div id="sub-view-2" class="sub-view hidden animation-fade">`;
                html += renderQuestionCard('既往手术史', `
                    ${renderCapsules('has_surgery', 'radio', [{ value: 'no', label: '无' }, { value: 'yes', label: '有' }], [d.has_surgery || 'no'])}
                    <div id="surgery-list-wrapper" class="${d.has_surgery === 'yes' ? '' : 'hidden'} mt-4">
                        <div id="surgery-list-container"></div>
                        <button type="button" class="w-full py-3 bg-blue-50 text-blue-600 rounded-xl text-sm font-bold mt-2 border border-blue-100 border-dashed hover:bg-blue-100 transition-colors" onclick="addHistoryItem('surgery')">
                            <i class="fas fa-plus mr-1"></i> 添加手术记录
                        </button>
                    </div>
                `);

                html += renderQuestionCard('既往外伤史', `
                    ${renderCapsules('has_trauma', 'radio', [{ value: 'no', label: '无' }, { value: 'yes', label: '有' }], [d.has_trauma || 'no'])}
                    <div id="trauma-list-wrapper" class="${d.has_trauma === 'yes' ? '' : 'hidden'} mt-4">
                        <div id="trauma-list-container"></div>
                        <button class="w-full py-3 bg-blue-50 text-blue-600 rounded-xl text-sm font-bold mt-2 border border-blue-100 border-dashed hover:bg-blue-100 transition-colors" onclick="addHistoryItem('trauma')">
                            <i class="fas fa-plus mr-1"></i> 添加外伤记录
                        </button>
                    </div>
                `);
                html += `</div>`;

                // --- Sub-View 3: 家族史 ---
                html += `<div id="sub-view-3" class="sub-view hidden animation-fade">`;
                const familyOpts = ['糖尿病', '高血压', '脑卒中', '冠心病/心肌梗死', '痛风/高尿酸血症', '血脂异常'];
                html += renderQuestionCard('疾病家族史 (直系亲属)',
                    `<div class="text-sm text-gray-500 mb-4">您的父母、兄弟姐妹、子女是否患有以下疾病？</div>` +
                    renderCapsules('family_history', 'checkbox', makeOpts(familyOpts), d.family_history)
                );
                html += `</div>`;

                // --- End Sub Views ---

                // 自动切换到第一个 Tab
                setTimeout(() => switchSubTab(0), 0);
            }
            else if (id === 7) {
                const d = healthData.section_7 || {};

                // --- 1. 吸烟史 ---
                html += `<div class="mb-6"><div class="text-sm font-bold text-gray-800 mb-2">1. 吸烟史</div>`;

                // Q1: 主动吸烟
                html += renderQuestionCard('Q1: 最近三个月，您是否主动吸烟？', `
                    ${renderCapsules('smoking_status', 'radio', [
                    { value: 'never', label: '① 从不吸烟' },
                    { value: 'current', label: '② 现在吸烟' },
                    { value: 'quit', label: '③ 已经戒烟' }
                ], [d.smoking_status])}
                    
                    <div id="smoking-current-details" class="${d.smoking_status === 'current' ? '' : 'hidden'} mt-3 p-3 bg-gray-50 rounded-xl border border-gray-100">
                        <div class="grid grid-cols-2 gap-3">
                             <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">平均每天吸烟(支)</label>
                                <input type="number" class="modern-input" data-key="smoking_amount" value="${d.smoking_amount || ''}">
                             </div>
                             <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">烟龄(年)</label>
                                <input type="number" class="modern-input" data-key="smoking_years" value="${d.smoking_years || ''}">
                             </div>
                        </div>
                    </div>
                `);

                // Q2: 被动吸烟
                html += renderQuestionCard('Q2: 最近三个月，您是否被动吸烟？', `
                    ${renderCapsules('passive_smoking', 'radio', [
                    { value: 'none', label: '① 基本没有 (<15分钟/天)' },
                    { value: 'yes', label: '② 是的' },
                    { value: 'past', label: '③ 既往是' }
                ], [d.passive_smoking])}
                    
                    <div id="passive-smoking-details" class="${d.passive_smoking === 'yes' ? '' : 'hidden'} mt-3 p-3 bg-gray-50 rounded-xl border border-gray-100">
                        <label class="block text-xs font-bold text-gray-500 mb-1">平均每天被动吸烟(小时)</label>
                        <input type="number" class="modern-input" data-key="passive_smoking_hours" value="${d.passive_smoking_hours || ''}">
                    </div>
                `);
                html += `</div>`;

                // --- 2. 饮酒史 ---
                html += `<div class="mb-6"><div class="text-sm font-bold text-gray-800 mb-2">2. 饮酒史</div>`;

                // Q1: 饮酒情况
                html += renderQuestionCard('Q1: 最近三个月，您是否饮酒？', `
                    ${renderCapsules('drinking_status', 'radio', [
                    { value: 'never', label: '① 从不喝酒' },
                    { value: 'current', label: '② 现在饮酒' },
                    { value: 'quit', label: '③ 已经戒酒' }
                ], [d.drinking_status])}
                    
                    <div id="drinking-current-details" class="${d.drinking_status === 'current' ? '' : 'hidden'} mt-3 p-3 bg-gray-50 rounded-xl border border-gray-100">
                        <div class="grid grid-cols-3 gap-2">
                             <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">每周(次)</label>
                                <input type="number" class="modern-input" data-key="drinking_freq" value="${d.drinking_freq || ''}">
                             </div>
                             <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">每次(mL)</label>
                                <input type="number" class="modern-input" data-key="drinking_amount" value="${d.drinking_amount || ''}">
                             </div>
                             <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">酒龄(年)</label>
                                <input type="number" class="modern-input" data-key="drinking_years" value="${d.drinking_years || ''}">
                             </div>
                        </div>
                    </div>
                `);

                // Q2: 酒类 (多选)
                html += renderQuestionCard('Q2: （多选）最近三个月，您主要喝什么酒？', `
                    ${renderCapsules('alcohol_type', 'checkbox', [
                    { value: 'white', label: '① 白酒' },
                    { value: 'red', label: '② 红酒' },
                    { value: 'beer', label: '③ 啤酒' },
                    { value: 'rice', label: '④ 米酒' },
                    { value: 'other', label: '⑤ 其它' }
                ], d.alcohol_type)}
                `);
                html += `</div>`;

                // --- 3. 运动史 ---
                html += `<div class="mb-6"><div class="text-sm font-bold text-gray-800 mb-2">3. 运动史</div>`;

                // Q1: 锻炼习惯
                html += renderQuestionCard('Q1: 最近三个月，您是否有锻炼习惯？', `
                    ${renderCapsules('exercise_habit', 'radio', [
                    { value: 'no', label: '① 否' },
                    { value: 'yes', label: '② 是' }
                ], [d.exercise_habit])}
                    
                    <div id="exercise-details-wrapper" class="${d.exercise_habit === 'yes' ? '' : 'hidden'} mt-3">
                        <div class="p-3 bg-gray-50 rounded-xl border border-gray-100 mb-4">
                            <label class="block text-xs font-bold text-gray-500 mb-1">您保持锻炼习惯已经(年)</label>
                            <input type="number" class="modern-input" data-key="exercise_years" value="${d.exercise_years || ''}">
                        </div>

                        <div class="text-xs font-bold text-gray-500 mb-2 ml-1">Q2: 最近三个月，您的锻炼方式、频率、时长是？</div>
                        <div id="exercise-types-container"></div>
                        <button type="button" class="w-full py-2 bg-white border border-dashed border-gray-300 rounded-lg text-sm text-gray-500 mt-2 hover:bg-gray-50" onclick="addExerciseType()">
                            <i class="fas fa-plus mr-1"></i> 添加锻炼方式
                        </button>
                        
                        <div class="mt-6">
                            <div class="text-xs font-bold text-gray-500 mb-2 ml-1">Q3: （多选）最近三个月，您锻炼时间段一般为？</div>
                            ${renderCapsules('exercise_time', 'checkbox', [
                    { value: 'morning', label: 'A 早上(早餐前)' },
                    { value: 'forenoon', label: 'B 上午(早中餐间)' },
                    { value: 'afternoon', label: 'C 下午(中晚餐间)' },
                    { value: 'night', label: 'D 晚上(晚餐后)' }
                ], d.exercise_time)}
                        </div>
                    </div>
                `);
                html += `</div>`;
            }
            else if (id === 8) {
                const d = healthData.section_8 || {};
                const foodGroups = [
                    { value: 'grain', label: '① 谷薯类', icon: 'fa-bread-slice' },
                    { value: 'veg_fruit', label: '② 蔬菜、水果类', icon: 'fa-carrot' },
                    { value: 'meat_egg', label: '③ 动物性食物', icon: 'fa-drumstick-bite' },
                    { value: 'milk', label: '④ 奶及奶制品', icon: 'fa-cheese' },
                    { value: 'bean', label: '⑤ 大豆类', icon: 'fa-seedling' },
                    { value: 'nut', label: '⑥ 坚果类', icon: 'fa-cookie' }
                ];

                // Q1: 早餐安排
                html += renderQuestionCard('1. 最近三个月，您的早餐通常怎么安排？<span class="text-xs font-normal text-gray-400 block mt-1">(指平均频率 ≥ 4次/周)</span>',
                    renderCapsules('breakfast_type', 'radio', [
                        { value: 'skip', label: '① 基本不吃' },
                        { value: 'out', label: '② 在外就餐(含外卖)' },
                        { value: 'cook', label: '③ 自己烹饪' }
                    ], [d.breakfast_type])
                );

                // Q2: 早餐搭配 (仅当Q1不选skip时显示)
                const showBreakfastComp = d.breakfast_type && d.breakfast_type !== 'skip';
                html += `<div id="q2-wrapper" class="${showBreakfastComp ? '' : 'hidden'}">`;
                html += renderQuestionCard('2. (多选) 早餐常如何搭配？<span class="text-xs font-normal text-gray-400 block mt-1">(指平均频率 ≥ 4次/周)</span>',
                    renderCapsules('breakfast_comp', 'checkbox', foodGroups, d.breakfast_comp)
                );
                html += `</div>`;

                // Q3: 午餐搭配
                html += renderQuestionCard('3. (多选) 午餐常如何搭配？<span class="text-xs font-normal text-gray-400 block mt-1">(指平均频率 ≥ 4次/周)</span>',
                    renderCapsules('lunch_comp', 'checkbox', foodGroups, d.lunch_comp)
                );

                // Q4: 晚餐搭配
                html += renderQuestionCard('4. (多选) 晚餐常如何搭配？<span class="text-xs font-normal text-gray-400 block mt-1">(指平均频率 ≥ 4次/周)</span>',
                    renderCapsules('dinner_comp', 'checkbox', foodGroups, d.dinner_comp)
                );

                // Q5: 晚餐后加餐
                html += renderQuestionCard('5. 最近三个月，您是否经常晚餐后加餐？<span class="text-xs font-normal text-gray-400 block mt-1">(指平均频率 ≥ 1次/周)</span>', `
                    ${renderCapsules('snack_habit', 'radio', [
                    { value: 'no', label: '① 否' },
                    { value: 'yes', label: '② 是' }
                ], [d.snack_habit])}
                    
                    <div id="snack-details" class="${d.snack_habit === 'yes' ? '' : 'hidden'} mt-3 p-3 bg-gray-50 rounded-xl border border-gray-100">
                        <div class="mb-2 text-xs font-bold text-gray-500">通常加餐时间</div>
                        <div class="flex items-center gap-2 mb-3">
                            <input type="number" class="modern-input w-20 text-center" placeholder="点" data-key="snack_time_hour" value="${d.snack_time_hour || ''}">
                            <span class="text-gray-400">:</span>
                            <input type="number" class="modern-input w-20 text-center" placeholder="分" data-key="snack_time_min" value="${d.snack_time_min || ''}">
                        </div>
                        <div class="mb-1 text-xs font-bold text-gray-500">平均频率(次/周)</div>
                        <input type="number" class="modern-input" data-key="snack_freq" value="${d.snack_freq || ''}">
                    </div>
                `);

                // Q6: 加餐搭配 (仅当Q5选yes时显示)
                const showSnackComp = d.snack_habit === 'yes';
                html += `<div id="q6-wrapper" class="${showSnackComp ? '' : 'hidden'}">`;
                html += renderQuestionCard('6. (多选) 加餐常如何搭配？<span class="text-xs font-normal text-gray-400 block mt-1">(指平均频率 ≥ 4次/周)</span>',
                    renderCapsules('snack_comp', 'checkbox', foodGroups, d.snack_comp)
                );
                html += `</div>`;

                // Q7: 按时就餐
                html += renderQuestionCard('7. 最近三个月，您一日三餐能够按时吗？<span class="text-xs font-normal text-gray-400 block mt-1">(早餐6:30~8:30，午餐11:30~13:30，晚餐18:00~20:00)</span>',
                    renderCapsules('meal_regularity', 'radio', [
                        { value: 'always', label: '① 按时 (7天/周)' },
                        { value: 'mostly', label: '② 基本按时 (4~6天/周)' },
                        { value: 'sometimes', label: '③ 有时按时 (1~3天/周)' },
                        { value: 'rarely', label: '④ 很少按时 (<1天/周)' }
                    ], [d.meal_regularity])
                );

                // Q8: 用餐时长
                html += renderQuestionCard('8. 用餐时长 (分钟)', `
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">早餐</label>
                            <input type="number" class="modern-input text-center" data-key="duration_breakfast" value="${d.duration_breakfast || ''}">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">午餐</label>
                            <input type="number" class="modern-input text-center" data-key="duration_lunch" value="${d.duration_lunch || ''}">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">晚餐</label>
                            <input type="number" class="modern-input text-center" data-key="duration_dinner" value="${d.duration_dinner || ''}">
                        </div>
                    </div>
                `);

                // Q9: 不良饮食习惯 (多选)
                html += renderQuestionCard('9. (多选) 最近三个月，您是否经常食用如下食品？<span class="text-xs font-normal text-gray-400 block mt-1">(指平均食用频率≥4次/周)</span>',
                    renderCapsules('unhealthy_food', 'checkbox', [
                        { value: 'fried', label: '① 油炸食品' },
                        { value: 'bbq', label: '② 熏烧烤食品' },
                        { value: 'cured', label: '③ 腌腊食品' },
                        { value: 'sauced', label: '④ 酱卤食品' },
                        { value: 'sausage', label: '⑤ 火腿肠' },
                        { value: 'instant', label: '⑥ 方便米面制品' },
                        { value: 'cookie', label: '⑦ 饼干' },
                        { value: 'puffed', label: '⑧ 膨化食品' },
                        { value: 'preserved', label: '⑨ 果脯/蜜饯' },
                        { value: 'spicy_strip', label: '⑩ 辣条' },
                        { value: 'sugary_drink', label: '⑪ 含糖或碳酸饮料' }
                    ], d.unhealthy_food)
                );

                // Q10: 烹饪方式 (多选)
                html += renderQuestionCard('10. (多选) 食品常经过以下哪种烹饪？<span class="text-xs font-normal text-gray-400 block mt-1">(指平均频率≥4次/周)</span>',
                    renderCapsules('cooking_method', 'checkbox', [
                        { value: 'fried_pan', label: '① 煎炸' },
                        { value: 'boiled', label: '② 烧煮' },
                        { value: 'stewed', label: '③ 炖煨' },
                        { value: 'stir_fried', label: '④ 爆炒' },
                        { value: 'smoked', label: '⑤ 熏烧烤' },
                        { value: 'steamed', label: '⑥ 蒸汆' },
                        { value: 'cured_cook', label: '⑦ 腌腊' },
                        { value: 'sauced_cook', label: '⑧ 酱卤' },
                        { value: 'other', label: '⑨ 其它' }
                    ], d.cooking_method) +
                    `<input type="text" class="modern-input mt-2" placeholder="其它烹饪方式..." data-key="cooking_method_other" value="${d.cooking_method_other || ''}">`
                );

                // Q11: 外食频率
                html += renderQuestionCard('11. 最近三个月，您平均一周在外就餐次数为？<span class="text-xs font-normal text-gray-400 block mt-1">(每餐算一次)</span>',
                    renderCapsules('eating_out_freq', 'radio', [
                        { value: 'lt1', label: '① 少于1次' },
                        { value: '1_6', label: '② 1~6次' },
                        { value: '7_13', label: '③ 7~13次' },
                        { value: '14_21', label: '④ 14~21次' },
                        { value: 'gt21', label: '⑤ ＞21次' }
                    ], [d.eating_out_freq])
                );

                // Q12: 饮水量
                html += renderQuestionCard('12. 最近三个月，您平均每日总饮水量约为？<span class="text-xs font-normal text-gray-400 block mt-1">(参照常规一次性纸杯约200mL)</span>',
                    `<div class="flex items-center gap-2">
                        <input type="number" class="modern-input flex-1" placeholder="请输入饮水量" data-key="water_intake" value="${d.water_intake || ''}">
                        <span class="text-gray-500 font-bold">mL</span>
                    </div>`
                );
            }
            else if (id === 5) {
                html += renderQuestionCard('当前最关注的健康问题',
                    `<textarea class="modern-input input-field" data-key="section_5" rows="5" placeholder="例如：最近睡眠不好，血糖波动大...">${healthData.section_5 || ''}</textarea>`
                );
            }
            else if (id === 6) {
                html += renderQuestionCard('期望的健康目标',
                    `<textarea class="modern-input input-field" data-key="section_6" rows="5" placeholder="例如：希望三个月内减重5斤...">${healthData.section_6 || ''}</textarea>`
                );
            }
            else if (id === 3) {
                const d = healthData.section_3_meta || {}; // Use a meta object for the yes/no toggle

                html += `<div class="mb-6">
                    <div class="text-sm text-gray-800 font-bold mb-2">三、健康产品及健康工具的使用信息</div>
                    <div class="text-xs text-gray-500 mb-4 leading-relaxed">
                        最近三个月，您是否使用过健康产品及健康工具，如保健食品、功能营养品以及健康工具等。（若近三个月未使用过请跳至下一题作答）
                    </div>
                    ${renderCapsules('has_used_products', 'radio', [
                    { value: 'no', label: '未曾使用', icon: 'fa-times' },
                    { value: 'yes', label: '有使用', icon: 'fa-check' }
                ], [d.has_used_products || 'no'])}
                 </div>`;

                html += `<div id="products-container" class="${d.has_used_products === 'yes' ? '' : 'hidden'}">`;
                html += `<div id="dynamic-list-container"></div>`;
                html += `
                    <div class="text-center mt-4">
                        <button class="bg-blue-50 text-blue-600 px-6 py-3 rounded-full font-bold shadow-sm active:scale-95 transition-transform" onclick="addListItem('products')">
                            <i class="fas fa-plus mr-2"></i> 添加产品/工具
                        </button>
                    </div>
                 `;
                html += `</div>`;
            }
            else if (id === 4) {
                const d = healthData.section_4_meta || {};

                html += `<div class="mb-6">
                    <div class="text-sm text-gray-800 font-bold mb-2">四、用药信息</div>
                    <div class="text-xs text-gray-500 mb-4 leading-relaxed">
                        最近一个月，您是否使用过药物。（若近一个月未使用过药物请跳至下一题作答）
                    </div>
                    ${renderCapsules('has_used_meds', 'radio', [
                    { value: 'no', label: '未曾使用', icon: 'fa-times' },
                    { value: 'yes', label: '有使用', icon: 'fa-check' }
                ], [d.has_used_meds || 'no'])}
                 </div>`;

                html += `<div id="meds-container" class="${d.has_used_meds === 'yes' ? '' : 'hidden'}">`;
                html += `<div id="dynamic-list-container"></div>`;
                html += `
                    <div class="text-center mt-4">
                        <button class="bg-blue-50 text-blue-600 px-6 py-3 rounded-full font-bold shadow-sm active:scale-95 transition-transform" onclick="addListItem('meds')">
                            <i class="fas fa-plus mr-2"></i> 添加药物
                        </button>
                    </div>
                 `;
                html += `</div>`;
            }

            container.innerHTML = html;

            // 列表渲染后续处理
            if (id === 3) {
                renderListItems('products', healthData.section_3);
            } else if (id === 4) {
                renderListItems('meds', healthData.section_4);
            } else if (id === 7) {
                if (!healthData.section_7.exercise_types) healthData.section_7.exercise_types = [{ type: '', freq: '', duration: '' }]; // Default one empty
                renderExerciseTypes();
            }

            if (id === 2) {
                if (!healthData.section_2.surgery_list) healthData.section_2.surgery_list = [];
                if (!healthData.section_2.trauma_list) healthData.section_2.trauma_list = [];
                renderHistoryItems('surgery', healthData.section_2.surgery_list);
                renderHistoryItems('trauma', healthData.section_2.trauma_list);
            }

            bindInputEvents();
        }

        function renderQuestionCard(title, content) {
            return `
                <div class="question-card">
                    <div class="q-title">${title}</div>
                    ${content}
                </div>
            `;
        }

        function renderSelect(key, options, selectedValue, placeholder = "请选择") {
            const opts = options.map(opt =>
                `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`
            ).join('');

            // 使用 SVG 箭头图标，保持 modern-input 风格
            const arrowIcon = `data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236b7280%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E`;

            return `
                <div class="relative">
                    <select class="modern-input input-field appearance-none" data-key="${key}" 
                        style="background-image: url('${arrowIcon}'); background-repeat: no-repeat; background-position: right 1rem center; background-size: 0.8em auto; padding-right: 2.5rem;">
                        <option value="" disabled ${!selectedValue ? 'selected' : ''}>${placeholder}</option>
                        ${opts}
                    </select>
                </div>
            `;
        }

        // ----- 动态列表逻辑 -----
        function renderListItems(type, data) {
            const container = document.getElementById('dynamic-list-container');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 py-8">暂无记录，点击下方按钮添加</div>`;
                return;
            }

            data.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'question-card relative';

                // Unified detailed view for products and meds
                const nameLabel = type === 'products' ? '产品或工具名称' : '药品名称';

                div.innerHTML = `
                    <button class="absolute top-4 right-4 text-red-400 p-2" onclick="removeListItem('${type}', ${index})"><i class="fas fa-trash"></i></button>
                    <div class="mb-4 pr-8">
                        <label class="block text-xs font-bold text-gray-500 mb-1">${nameLabel}</label>
                        <input type="text" class="modern-input" placeholder="请输入名称" value="${item.name || ''}" oninput="updateListItem('${type}', ${index}, 'name', this.value)">
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">单次剂量</label>
                            <input type="text" class="modern-input" placeholder="例如: 1粒" value="${item.dose || ''}" oninput="updateListItem('${type}', ${index}, 'dose', this.value)">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">途径</label>
                            <input type="text" class="modern-input" placeholder="例如: 口服" value="${item.route || ''}" oninput="updateListItem('${type}', ${index}, 'route', this.value)">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-xs font-bold text-gray-500 mb-1">每日使用时间及频率</label>
                        <input type="text" class="modern-input" placeholder="eg. 早中晚 1:1:1" value="${item.freq || ''}" oninput="updateListItem('${type}', ${index}, 'freq', this.value)">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">使用年限</label>
                        <input type="text" class="modern-input" placeholder="例如: 1年" value="${item.duration || ''}" oninput="updateListItem('${type}', ${index}, 'duration', this.value)">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function addListItem(type) {
            const list = type === 'products' ? healthData.section_3 : healthData.section_4;
            // Both products and meds use the same data structure
            list.push({ name: '', dose: '', route: '', freq: '', duration: '' });

            renderListItems(type, list);
            saveData();
            updateCurrentSectionUI();
        }
        function removeListItem(type, index) {
            const list = type === 'products' ? healthData.section_3 : healthData.section_4;
            list.splice(index, 1);
            renderListItems(type, list);
            saveData();
            updateCurrentSectionUI();
        }
        function updateListItem(type, index, key, val) {
            const list = type === 'products' ? healthData.section_3 : healthData.section_4;
            list[index][key] = val;
            saveData();
            updateCurrentSectionUI();
        }

        // ----- History Items (Surgery/Trauma) -----
        function renderHistoryItems(type, data) {
            const container = document.getElementById(type + '-list-container');
            container.innerHTML = '';
            if (data.length === 0) return;

            data.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-3 rounded-lg border border-gray-100 mb-2 relative';
                div.innerHTML = `
                    <button class="absolute top-2 right-2 text-gray-400 hover:text-red-500" onclick="removeHistoryItem('${type}', ${index})"><i class="fas fa-times"></i></button>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="col-span-2">
                            <label class="block text-xs text-gray-500 mb-1">名称</label>
                            <input type="text" class="modern-input py-1 px-2 text-sm" value="${item.name || ''}" placeholder="例如：阑尾炎手术" oninput="updateHistoryItem('${type}', ${index}, 'name', this.value)">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">时间</label>
                            <input type="month" class="modern-input py-1 px-2 text-sm" value="${item.date || ''}" oninput="updateHistoryItem('${type}', ${index}, 'date', this.value)">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        function addHistoryItem(type) {
            const list = type === 'surgery' ? healthData.section_2.surgery_list : healthData.section_2.trauma_list;
            list.push({ name: '', date: '' });
            renderHistoryItems(type, list);
            saveData();
        }
        function removeHistoryItem(type, index) {
            const list = type === 'surgery' ? healthData.section_2.surgery_list : healthData.section_2.trauma_list;
            list.splice(index, 1);
            renderHistoryItems(type, list);
            saveData();
        }
        function updateHistoryItem(type, index, key, val) {
            const list = type === 'surgery' ? healthData.section_2.surgery_list : healthData.section_2.trauma_list;
            list[index][key] = val;
            saveData();
        }

        // ----- Section 7 Exercise Types Logic -----
        function renderExerciseTypes() {
            const container = document.getElementById('exercise-types-container');
            if (!container) return;
            container.innerHTML = '';

            const list = healthData.section_7.exercise_types || [];
            list.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bg-white p-3 rounded-xl border border-gray-200 mb-2 relative shadow-sm';
                div.innerHTML = `
                    <div class="grid grid-cols-1 gap-2">
                        <div>
                            <label class="text-xs text-gray-400">锻炼方式</label>
                            <input type="text" class="modern-input py-1 px-2 text-sm" placeholder="如散步、游泳" value="${item.type || ''}" oninput="updateExerciseType(${index}, 'type', this.value)">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs text-gray-400">频率(次/周)</label>
                                <input type="number" class="modern-input py-1 px-2 text-sm" value="${item.freq || ''}" oninput="updateExerciseType(${index}, 'freq', this.value)">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">时长(分钟/次)</label>
                                <input type="number" class="modern-input py-1 px-2 text-sm" value="${item.duration || ''}" oninput="updateExerciseType(${index}, 'duration', this.value)">
                            </div>
                        </div>
                    </div>
                    ${list.length > 1 ? `<button class="absolute top-2 right-2 text-gray-300 hover:text-red-400" onclick="removeExerciseType(${index})"><i class="fas fa-times"></i></button>` : ''}
                `;
                container.appendChild(div);
            });
        }
        function addExerciseType() {
            if (!healthData.section_7.exercise_types) healthData.section_7.exercise_types = [];
            healthData.section_7.exercise_types.push({ type: '', freq: '', duration: '' });
            renderExerciseTypes();
            saveData();
        }
        function removeExerciseType(index) {
            healthData.section_7.exercise_types.splice(index, 1);
            renderExerciseTypes();
            saveData();
        }
        function updateExerciseType(index, key, val) {
            healthData.section_7.exercise_types[index][key] = val;
            saveData();
        }

        // ----- 数据绑定与自动保存 -----
        function bindInputEvents() {
            const inputs = document.querySelectorAll('#detail-form input, #detail-form textarea');
            inputs.forEach(input => {
                input.addEventListener('change', (e) => handleInputChange(e.target));
                if (input.tagName === 'TEXTAREA' || input.type === 'text') {
                    input.addEventListener('input', (e) => handleInputChange(e.target));
                }
            });
        }

        function handleInputChange(input) {
            // Special logic for health products toggle
            if (input.name === 'has_used_products') {
                const el = document.getElementById('products-container');
                if (input.value === 'yes') el.classList.remove('hidden');
                else el.classList.add('hidden');

                // Save to meta
                if (!healthData.section_3_meta) healthData.section_3_meta = {};
                healthData.section_3_meta.has_used_products = input.value;
                saveData();
                updateCurrentSectionUI();
                return;
            }
            // Special logic for meds toggle
            if (input.name === 'has_used_meds') {
                const el = document.getElementById('meds-container');
                if (input.value === 'yes') el.classList.remove('hidden');
                else el.classList.add('hidden');

                // Save to meta
                if (!healthData.section_4_meta) healthData.section_4_meta = {};
                healthData.section_4_meta.has_used_meds = input.value;
                saveData();
                updateCurrentSectionUI();
                return;
            }

            // Section 7 toggles
            if (input.name === 'smoking_status') {
                const el = document.getElementById('smoking-current-details');
                if (el) {
                    if (input.value === 'current') el.classList.remove('hidden');
                    else el.classList.add('hidden');
                }
            }
            if (input.name === 'passive_smoking') {
                const el = document.getElementById('passive-smoking-details');
                if (el) {
                    if (input.value === 'yes') el.classList.remove('hidden');
                    else el.classList.add('hidden');
                }
            }
            if (input.name === 'drinking_status') {
                const el = document.getElementById('drinking-current-details');
                if (el) {
                    if (input.value === 'current') el.classList.remove('hidden');
                    else el.classList.add('hidden');
                }
            }
            if (input.name === 'exercise_habit') {
                const el = document.getElementById('exercise-details-wrapper');
                if (el) {
                    if (input.value === 'yes') el.classList.remove('hidden');
                    else el.classList.add('hidden');
                }
            }

            // Section 8 toggles
            if (input.name === 'breakfast_type') {
                const el = document.getElementById('q2-wrapper');
                if (el) {
                    if (input.value === 'skip') el.classList.add('hidden');
                    else el.classList.remove('hidden');
                }
            }
            if (input.name === 'snack_habit') {
                const details = document.getElementById('snack-details');
                const q6 = document.getElementById('q6-wrapper');
                if (input.value === 'yes') {
                    if (details) details.classList.remove('hidden');
                    if (q6) q6.classList.remove('hidden');
                } else {
                    if (details) details.classList.add('hidden');
                    if (q6) q6.classList.add('hidden');
                }
            }

            // 特殊逻辑：女性孕期显隐
            if (input.name === 'gender') {
                const pregField = document.getElementById('field-pregnancy');
                if (input.value === 'female') pregField.classList.remove('hidden');
                else pregField.classList.add('hidden');
            }
            // Surgery / Trauma toggle
            if (input.name === 'has_surgery') {
                const el = document.getElementById('surgery-list-wrapper');
                if (input.value === 'yes') el.classList.remove('hidden');
                else el.classList.add('hidden');
            }
            if (input.name === 'has_trauma') {
                const el = document.getElementById('trauma-list-wrapper');
                if (input.value === 'yes') el.classList.remove('hidden');
                else el.classList.add('hidden');
            }

            // 保存数据
            if (input.type === 'radio') {
                if (input.checked) updateData(currentSectionId, input.name, input.value);
            } else if (input.type === 'checkbox') {
                const checked = Array.from(document.querySelectorAll(`input[name="${input.name}"]:checked`)).map(c => c.value);
                updateData(currentSectionId, input.name, checked);
            } else {
                const key = input.getAttribute('data-key');
                if (key) {
                    // 防止身份证脱敏值被保存
                    if (key === 'id_card' && input.value.includes('*')) {
                        return;
                    }
                    updateData(currentSectionId, key, input.value);
                }
            }
        }

        function updateData(secId, key, val) {
            // Section 5/6 映射
            if (key === 'section_5') healthData.section_5 = val;
            else if (key === 'section_6') healthData.section_6 = val;
            else {
                const sKey = 'section_' + secId;
                if (!healthData[sKey]) healthData[sKey] = {};
                healthData[sKey][key] = val;
            }
            saveData();
            updateCurrentSectionUI();
        }

        function saveData() {
            if (currentProfileId) {
                // 保存到档案列表中对应的档案
                let profiles = JSON.parse(localStorage.getItem(PROFILES_KEY) || '[]');
                const index = profiles.findIndex(p => p.id === currentProfileId);
                if (index !== -1) {
                    profiles[index].data = healthData;
                    profiles[index].updatedAt = new Date().toISOString();
                    profiles[index].progress = calcGlobalProgress();
                    localStorage.setItem(PROFILES_KEY, JSON.stringify(profiles));
                }
            } else {
                // 兼容旧版：保存到旧格式
                localStorage.setItem('health_profile_detailed_v5', JSON.stringify(healthData));
            }
        }

        // 计算全局进度（返回数值，供保存时使用）
        function calcGlobalProgress() {
            let totalScore = 0;
            const maxScore = 800;

            for (let i = 1; i <= 8; i++) {
                let p = calcSingleSectionProgress(i);
                totalScore += p;
            }

            return Math.round((totalScore / maxScore) * 100);
        }

        // ----- 进度计算逻辑 -----
        function calcSingleSectionProgress(id) {
            let p = 0;
            if (id === 1) { // 基本信息：关键字段
                const d = healthData.section_1 || {};
                let fields = [
                    'gender', 'dob', 'marital', 'income', 'ethnicity', 'native_place',
                    'id_card', 'contact_1',
                    'emergency_1_name', 'emergency_1_phone',
                    'address_province', 'address_city',
                    'living_situation', 'education', 'employment_status', 'work_unit'
                ];
                // 女性且孕期字段必填
                if (d.gender === 'female') fields.push('pregnancy');

                let filled = fields.filter(f => d[f] && d[f].trim() !== '').length;
                p = (filled / fields.length) * 100;
            }
            else if (id === 2) { // 疾病信息 (详细版)
                const d = healthData.section_2 || {};
                let score = 0;
                // 1. Any disease/symptom checked?
                let hasAnyCheck = false;
                for (let k in d) {
                    // Check if it is a disease/symptom array (ignore surgery/trauma lists here)
                    if (k !== 'surgery_list' && k !== 'trauma_list' && Array.isArray(d[k]) && d[k].length > 0) hasAnyCheck = true;
                    if (k.endsWith('_other') && d[k].trim() !== '') hasAnyCheck = true;
                }
                if (hasAnyCheck) score += 40;

                // 2. Surgery answered
                if (d.has_surgery) score += 20;

                // 3. Trauma answered
                if (d.has_trauma) score += 20;

                // 4. Family History answered
                if (d.family_history && d.family_history.length > 0) score += 20;
                // If family history is empty but surgery/trauma answered, maybe they skipped family history? 
                // It's a "checkbox" question, so hard to distinguish "none" from "skipped" without an explicit "None".
                // For now, if other parts are filled, we can be lenient or strict. 
                // Let's assume if they interacted with other parts, they might have seen this.
                // But strictly, 0% if unchecked.

                p = score;
            }
            else if (id === 7 || id === 8) { // 选项类
                const d = healthData['section_' + id] || {};
                let p = 0;

                if (id === 7) {
                    // Smoking
                    let s1 = 0;
                    if (d.smoking_status) {
                        if (d.smoking_status === 'current') s1 = (d.smoking_amount && d.smoking_years) ? 1 : 0.5;
                        else s1 = 1;
                    }

                    let s2 = 0;
                    if (d.passive_smoking) {
                        if (d.passive_smoking === 'yes') s2 = d.passive_smoking_hours ? 1 : 0.5;
                        else s2 = 1;
                    }

                    // Drinking
                    let d1 = 0;
                    if (d.drinking_status) {
                        if (d.drinking_status === 'current') d1 = (d.drinking_freq && d.drinking_amount && d.drinking_years) ? 1 : 0.5;
                        else d1 = 1;
                    }
                    let d2 = (d.alcohol_type && d.alcohol_type.length > 0) ? 1 : 0; // Optional but good to have

                    // Exercise
                    let e1 = 0;
                    if (d.exercise_habit) {
                        if (d.exercise_habit === 'yes') {
                            // Check details
                            const types = d.exercise_types || [];
                            const validTypes = types.filter(t => t.type && t.freq && t.duration);
                            e1 = (d.exercise_years && validTypes.length > 0) ? 1 : 0.5;
                        } else {
                            e1 = 1;
                        }
                    }

                    // Weighting: Smoking(30%), Drinking(30%), Exercise(40%)
                    // Normalize sub-scores
                    const scoreSmoking = (s1 + s2) / 2;
                    const scoreDrinking = (d1 + d2) / 2;
                    const scoreExercise = e1;

                    p = (scoreSmoking * 30) + (scoreDrinking * 30) + (scoreExercise * 40);
                }
                else if (id === 8) { // Dietary
                    const d = healthData.section_8 || {};
                    let score = 0;
                    let maxScore = 0;

                    // Q1
                    if (d.breakfast_type) {
                        score += 10;
                        maxScore += 10;
                        // Q2 Logic
                        if (d.breakfast_type !== 'skip') {
                            maxScore += 15;
                            if (d.breakfast_comp && d.breakfast_comp.length > 0) score += 15;
                        }
                    } else {
                        maxScore += 25; // Potentially Q1+Q2
                    }

                    // Q3
                    maxScore += 15;
                    if (d.lunch_comp && d.lunch_comp.length > 0) score += 15;

                    // Q4
                    maxScore += 15;
                    if (d.dinner_comp && d.dinner_comp.length > 0) score += 15;

                    // Q5
                    if (d.snack_habit) {
                        score += 10;
                        maxScore += 10;
                        // Q6 Logic
                        if (d.snack_habit === 'yes') {
                            maxScore += 15;
                            if (d.snack_comp && d.snack_comp.length > 0) score += 15;
                        }
                    } else {
                        maxScore += 25;
                    }

                    // Q7
                    maxScore += 20;
                    if (d.meal_regularity) score += 20;

                    // Q8 (3 parts)
                    maxScore += 15;
                    if (d.duration_breakfast && d.duration_lunch && d.duration_dinner) score += 15;

                    // Q9 (Optional but tracked)
                    maxScore += 10;
                    if (d.unhealthy_food && d.unhealthy_food.length > 0) score += 10;

                    // Q10
                    maxScore += 10;
                    if ((d.cooking_method && d.cooking_method.length > 0) || d.cooking_method_other) score += 10;

                    // Q11
                    maxScore += 10;
                    if (d.eating_out_freq) score += 10;

                    // Q12
                    maxScore += 10;
                    if (d.water_intake) score += 10;

                    p = maxScore > 0 ? (score / maxScore) * 100 : 0;
                }
                return Math.round(p);
            }
            else if (id === 3 || id === 4) {
                const metaKey = id === 3 ? 'section_3_meta' : 'section_4_meta';
                const toggleKey = id === 3 ? 'has_used_products' : 'has_used_meds';
                const listData = id === 3 ? healthData.section_3 : healthData.section_4;

                const meta = healthData[metaKey] || {};

                if (meta[toggleKey] === 'no') {
                    p = 100;
                } else if (meta[toggleKey] === 'yes') {
                    const l = listData || [];
                    const validItems = l.filter(i => i.name && i.name.trim() !== '');
                    p = validItems.length > 0 ? 100 : 0;
                } else {
                    p = 0;
                }
            }
            else if (id === 5) { // 关注的健康问题
                p = (healthData.section_5 && healthData.section_5.length > 1) ? 100 : 0;
            }
            else if (id === 6) { // 期望的健康目标
                p = (healthData.section_6 && healthData.section_6.length > 1) ? 100 : 0;
            }
            return Math.min(100, Math.round(p));
        }

        function updateCurrentSectionUI() {
            if (currentView !== 'detail') return;
            const p = calcSingleSectionProgress(currentSectionId);
            document.getElementById('section-progress-text').innerText = p + '%';
            document.getElementById('section-progress-bar').style.width = p + '%';
        }

        function updateGlobalProgress() {
            let totalScore = 0;
            const maxScore = 800; // 8个模块

            for (let i = 1; i <= 8; i++) {
                let p = calcSingleSectionProgress(i);

                // 更新 Dashboard 小进度条
                const bar = document.getElementById(`prog-${i}`);
                const badge = document.getElementById(`badge-${i}`);
                if (bar) {
                    bar.style.width = p + '%';
                    if (p === 100) badge.classList.add('completed');
                    else badge.classList.remove('completed');
                }

                totalScore += p;
            }

            const finalPercent = Math.round((totalScore / maxScore) * 100);

            // 更新环形进度条
            const circle = document.getElementById('global-circle');
            const text = document.getElementById('global-text');
            if (circle && text) {
                circle.setAttribute('stroke-dasharray', `${finalPercent}, 100`);
                text.textContent = finalPercent + '%';
            }
        }

    </script>

    <!-- 全局错误处理 -->
    <script>
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error:', e.message);
            // 阻止错误弹窗，但不影响页面显示
            return true;
        });

        // 安全的getElementById包装函数
        function safeGetElement(id) {
            return document.getElementById(id);
        }

        // 安全的textContent设置函数
        function safeSetText(id, text) {
            const element = document.getElementById(id);
            if (element && text !== undefined && text !== null) {
                element.textContent = text;
            }
            return element;
        }
        // 安全的震动函数（避免iframe中的跨域限制）
        function safeVibrate(duration) {
            try {
                // 检查是否支持震动API
                if (navigator.vibrate && window.self === window.top) {
                    navigator.vibrate(duration);
                }
            } catch (e) {
                // 忽略震动API错误
                console.debug('Vibrate not available:', e.message);
            }
        }

    </script>
</body>

</html>